/**
 * skylark-vr360viewer - A version of vr360viewer that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-vr360viewer/
 * @license MIT
 */
!function(t,e){var r=e.define,require=e.require,a="function"==typeof r&&r.amd,o=!a&&"undefined"!=typeof exports;if(!a&&!r){var h={};r=e.define=function(t,e,i){"function"==typeof i?(h[t]={factory:i,deps:e.map(function(e){return function(t,e){if("."!==t[0])return t;var i=e.split("/"),s=t.split("/");i.pop();for(var n=0;n<s.length;n++)"."!=s[n]&&(".."==s[n]?i.pop():i.push(s[n]));return i.join("/")}(e,t)}),resolved:!1,exports:null},require(t)):h[t]={factory:null,resolved:!0,exports:i}},require=e.require=function(t){if(!h.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var module=h[t];if(!module.resolved){var i=[];module.deps.forEach(function(t){i.push(require(t))}),module.exports=module.factory.apply(e,i)||null,module.resolved=!0}return module.exports}}if(!r)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,require){t("skylark-langx-ns/_attach",[],function(){return function(t,e,i){"string"==typeof e&&(e=e.split("."));for(var s=e.length,n=t,r=0,a=e[r++];r<s;)n=n[a]=n[a]||{},a=e[r++];return n[a]=i}}),t("skylark-langx-ns/ns",["./_attach"],function(t){var e={attach:function(i,s){return t(e,i,s)}};return e}),t("skylark-langx-ns/main",["./ns"],function(t){return t}),t("skylark-langx-ns",["skylark-langx-ns/main"],function(t){return t}),t("skylark-langx/skylark",["skylark-langx-ns"],function(t){return t}),t("skylark-pox/pox",["skylark-langx/skylark"],function(t){const e={};function i(t){return document.getElementById(t)}return e.$=i,e.RAD=Math.PI/180,e.msg=(t=>{let e=new Date;if("string"==typeof t){let e=location.protocol+"//"+location.host;t=t.replace(new RegExp(e,"g"),"").replace(/data:[^:]+/,"module")}if(i("msglog")&&(i("msglog").value+=e.toTimeString().substr(0,8)+"."+("000"+e.getMilliseconds()).substr(-3)+" "+t+"\n",i("msglog").scrollTop=i("msglog").scrollHeight),!i("msgc"))return void console.log(t);const s=document.createElement("div");s.innerHTML=t,i("msgc").appendChild(s),i("msg").scrollTop=i("msgc").offsetHeight}),t.attach("intg.pox",e)}),t("skylark-pox/CanvasMatrix4",["./pox"],function(t){var e=function(t){if(void 0!=t&&"Float32Array"==t.name)return this.buf=t,this;if(this.buf=new Float32Array(16),this.matrix=null,"object"==typeof t){if("length"in t&&t.length>=16)return this.load(t),this;if(t instanceof e)return this.load(t),this}return this.makeIdentity(),this};return e.RAD=t.RAD,e.prototype.load=function(){if(1==arguments.length&&"object"==typeof arguments[0]){var t=arguments[0];if("length"in t&&16==t.length)return this.buf[0]=t[0],this.buf[1]=t[1],this.buf[2]=t[2],this.buf[3]=t[3],this.buf[4]=t[4],this.buf[5]=t[5],this.buf[6]=t[6],this.buf[7]=t[7],this.buf[8]=t[8],this.buf[9]=t[9],this.buf[10]=t[10],this.buf[11]=t[11],this.buf[12]=t[12],this.buf[13]=t[13],this.buf[14]=t[14],this.buf[15]=t[15],this;if(arguments[0]instanceof e)return this.buf[0]=t.buf[0],this.buf[1]=t.buf[1],this.buf[2]=t.buf[2],this.buf[3]=t.buf[3],this.buf[4]=t.buf[4],this.buf[5]=t.buf[5],this.buf[6]=t.buf[6],this.buf[7]=t.buf[7],this.buf[8]=t.buf[8],this.buf[9]=t.buf[9],this.buf[10]=t.buf[10],this.buf[11]=t.buf[11],this.buf[12]=t.buf[12],this.buf[13]=t.buf[13],this.buf[14]=t.buf[14],this.buf[15]=t.buf[15],this}return this.makeIdentity(),this},e.prototype.getAsArray=function(){return[this.buf[0],this.buf[1],this.buf[2],this.buf[3],this.buf[4],this.buf[5],this.buf[6],this.buf[7],this.buf[8],this.buf[9],this.buf[10],this.buf[11],this.buf[12],this.buf[13],this.buf[14],this.buf[15]]},e.prototype.getAsWebGLFloatArray=function(){return this.buf},e.prototype.initmatrix=function(){return this.matrix||(this.matrix=new e),this.matrix.makeIdentity(),this},e.prototype.makeIdentity=function(){return this.buf[0]=1,this.buf[1]=0,this.buf[2]=0,this.buf[3]=0,this.buf[4]=0,this.buf[5]=1,this.buf[6]=0,this.buf[7]=0,this.buf[8]=0,this.buf[9]=0,this.buf[10]=1,this.buf[11]=0,this.buf[12]=0,this.buf[13]=0,this.buf[14]=0,this.buf[15]=1,this},e.prototype.transpose=function(){var t=this.buf[1];return this.buf[1]=this.buf[4],this.buf[4]=t,t=this.buf[2],this.buf[2]=this.buf[8],this.buf[8]=t,t=this.buf[3],this.buf[3]=this.buf[12],this.buf[12]=t,t=this.buf[6],this.buf[6]=this.buf[9],this.buf[9]=t,t=this.buf[7],this.buf[7]=this.buf[13],this.buf[13]=t,t=this.buf[11],this.buf[11]=this.buf[14],this.buf[14]=t,this},e.prototype.invert=function(){var t=this._determinant4x4();return Math.abs(t)<1e-8?null:(this._makeAdjoint(),this.buf[0]/=t,this.buf[1]/=t,this.buf[2]/=t,this.buf[3]/=t,this.buf[4]/=t,this.buf[5]/=t,this.buf[6]/=t,this.buf[7]/=t,this.buf[8]/=t,this.buf[9]/=t,this.buf[10]/=t,this.buf[11]/=t,this.buf[12]/=t,this.buf[13]/=t,this.buf[14]/=t,this.buf[15]/=t,this)},e.prototype.translate=function(t,e,i){return(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],t=t[0]),void 0==t&&(t=0),void 0==e&&(e=0),void 0==i&&(i=0),this.buf[12]+=t,this.buf[13]+=e,this.buf[14]+=i,this},e.prototype.scale=function(t,e,i){return(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],t=t[0]),void 0==t&&(t=1),void 0==i?void 0==e?(e=t,i=t):i=1:void 0==e&&(e=t),this.buf[0]*=t,this.buf[1]*=t,this.buf[2]*=t,this.buf[4]*=e,this.buf[5]*=e,this.buf[6]*=e,this.buf[8]*=i,this.buf[9]*=i,this.buf[10]*=i,this},e.prototype.rotate=function(t,i,s,n){if(0==t)return this;(Array.isArray(i)||i instanceof Float32Array)&&(s=i[1],n=i[2],i=i[0]),t*=e.RAD,t/=2;var r=Math.sin(t),a=Math.cos(t),o=r*r;if(this.initmatrix(),1==i&&0==s&&0==n)this.matrix.buf[5]=1-2*o,this.matrix.buf[6]=2*r*a,this.matrix.buf[9]=-2*r*a,this.matrix.buf[10]=1-2*o;else if(0==i&&1==s&&0==n)this.matrix.buf[0]=1-2*o,this.matrix.buf[2]=-2*r*a,this.matrix.buf[8]=2*r*a,this.matrix.buf[10]=1-2*o;else if(0==i&&0==s&&1==n)this.matrix.buf[0]=1-2*o,this.matrix.buf[1]=2*r*a,this.matrix.buf[4]=-2*r*a,this.matrix.buf[5]=1-2*o;else{var h=Math.hypot(i,s,n);0==h?(i=0,s=0,n=1):1!=h&&(i/=h,s/=h,n/=h);var u=i*i,c=s*s,l=n*n;this.matrix.buf[0]=1-2*(c+l)*o,this.matrix.buf[1]=2*(i*s*o+n*r*a),this.matrix.buf[2]=2*(i*n*o-s*r*a),this.matrix.buf[4]=2*(s*i*o-n*r*a),this.matrix.buf[5]=1-2*(l+u)*o,this.matrix.buf[6]=2*(s*n*o+i*r*a),this.matrix.buf[8]=2*(n*i*o+s*r*a),this.matrix.buf[9]=2*(n*s*o-i*r*a),this.matrix.buf[10]=1-2*(u+c)*o}return this.multRight(this.matrix),this},e.prototype.multRight=function(t){var e=this.buf[0]*t.buf[0]+this.buf[1]*t.buf[4]+this.buf[2]*t.buf[8]+this.buf[3]*t.buf[12],i=this.buf[0]*t.buf[1]+this.buf[1]*t.buf[5]+this.buf[2]*t.buf[9]+this.buf[3]*t.buf[13],s=this.buf[0]*t.buf[2]+this.buf[1]*t.buf[6]+this.buf[2]*t.buf[10]+this.buf[3]*t.buf[14],n=this.buf[0]*t.buf[3]+this.buf[1]*t.buf[7]+this.buf[2]*t.buf[11]+this.buf[3]*t.buf[15],r=this.buf[4]*t.buf[0]+this.buf[5]*t.buf[4]+this.buf[6]*t.buf[8]+this.buf[7]*t.buf[12],a=this.buf[4]*t.buf[1]+this.buf[5]*t.buf[5]+this.buf[6]*t.buf[9]+this.buf[7]*t.buf[13],o=this.buf[4]*t.buf[2]+this.buf[5]*t.buf[6]+this.buf[6]*t.buf[10]+this.buf[7]*t.buf[14],h=this.buf[4]*t.buf[3]+this.buf[5]*t.buf[7]+this.buf[6]*t.buf[11]+this.buf[7]*t.buf[15],u=this.buf[8]*t.buf[0]+this.buf[9]*t.buf[4]+this.buf[10]*t.buf[8]+this.buf[11]*t.buf[12],c=this.buf[8]*t.buf[1]+this.buf[9]*t.buf[5]+this.buf[10]*t.buf[9]+this.buf[11]*t.buf[13],l=this.buf[8]*t.buf[2]+this.buf[9]*t.buf[6]+this.buf[10]*t.buf[10]+this.buf[11]*t.buf[14],f=this.buf[8]*t.buf[3]+this.buf[9]*t.buf[7]+this.buf[10]*t.buf[11]+this.buf[11]*t.buf[15],p=this.buf[12]*t.buf[0]+this.buf[13]*t.buf[4]+this.buf[14]*t.buf[8]+this.buf[15]*t.buf[12],m=this.buf[12]*t.buf[1]+this.buf[13]*t.buf[5]+this.buf[14]*t.buf[9]+this.buf[15]*t.buf[13],d=this.buf[12]*t.buf[2]+this.buf[13]*t.buf[6]+this.buf[14]*t.buf[10]+this.buf[15]*t.buf[14],b=this.buf[12]*t.buf[3]+this.buf[13]*t.buf[7]+this.buf[14]*t.buf[11]+this.buf[15]*t.buf[15];return this.buf[0]=e,this.buf[1]=i,this.buf[2]=s,this.buf[3]=n,this.buf[4]=r,this.buf[5]=a,this.buf[6]=o,this.buf[7]=h,this.buf[8]=u,this.buf[9]=c,this.buf[10]=l,this.buf[11]=f,this.buf[12]=p,this.buf[13]=m,this.buf[14]=d,this.buf[15]=b,this},e.prototype.multLeft=function(t){var e=t.buf[0]*this.buf[0]+t.buf[1]*this.buf[4]+t.buf[2]*this.buf[8]+t.buf[3]*this.buf[12],i=t.buf[0]*this.buf[1]+t.buf[1]*this.buf[5]+t.buf[2]*this.buf[9]+t.buf[3]*this.buf[13],s=t.buf[0]*this.buf[2]+t.buf[1]*this.buf[6]+t.buf[2]*this.buf[10]+t.buf[3]*this.buf[14],n=t.buf[0]*this.buf[3]+t.buf[1]*this.buf[7]+t.buf[2]*this.buf[11]+t.buf[3]*this.buf[15],r=t.buf[4]*this.buf[0]+t.buf[5]*this.buf[4]+t.buf[6]*this.buf[8]+t.buf[7]*this.buf[12],a=t.buf[4]*this.buf[1]+t.buf[5]*this.buf[5]+t.buf[6]*this.buf[9]+t.buf[7]*this.buf[13],o=t.buf[4]*this.buf[2]+t.buf[5]*this.buf[6]+t.buf[6]*this.buf[10]+t.buf[7]*this.buf[14],h=t.buf[4]*this.buf[3]+t.buf[5]*this.buf[7]+t.buf[6]*this.buf[11]+t.buf[7]*this.buf[15],u=t.buf[8]*this.buf[0]+t.buf[9]*this.buf[4]+t.buf[10]*this.buf[8]+t.buf[11]*this.buf[12],c=t.buf[8]*this.buf[1]+t.buf[9]*this.buf[5]+t.buf[10]*this.buf[9]+t.buf[11]*this.buf[13],l=t.buf[8]*this.buf[2]+t.buf[9]*this.buf[6]+t.buf[10]*this.buf[10]+t.buf[11]*this.buf[14],f=t.buf[8]*this.buf[3]+t.buf[9]*this.buf[7]+t.buf[10]*this.buf[11]+t.buf[11]*this.buf[15],p=t.buf[12]*this.buf[0]+t.buf[13]*this.buf[4]+t.buf[14]*this.buf[8]+t.buf[15]*this.buf[12],m=t.buf[12]*this.buf[1]+t.buf[13]*this.buf[5]+t.buf[14]*this.buf[9]+t.buf[15]*this.buf[13],d=t.buf[12]*this.buf[2]+t.buf[13]*this.buf[6]+t.buf[14]*this.buf[10]+t.buf[15]*this.buf[14],b=t.buf[12]*this.buf[3]+t.buf[13]*this.buf[7]+t.buf[14]*this.buf[11]+t.buf[15]*this.buf[15];return this.buf[0]=e,this.buf[1]=i,this.buf[2]=s,this.buf[3]=n,this.buf[4]=r,this.buf[5]=a,this.buf[6]=o,this.buf[7]=h,this.buf[8]=u,this.buf[9]=c,this.buf[10]=l,this.buf[11]=f,this.buf[12]=p,this.buf[13]=m,this.buf[14]=d,this.buf[15]=b,this},e.prototype.ortho=function(t,e,i,s,n,r){var a=(t+e)/(e-t),o=(s+i)/(s-i),h=(r+n)/(r-n);return this.initmatrix(),this.matrix.buf[0]=2/(e-t),this.matrix.buf[5]=2/(s-i),this.matrix.buf[10]=-2/(r-n),this.matrix.buf[12]=a,this.matrix.buf[13]=o,this.matrix.buf[14]=-h,this.multRight(this.matrix),this},e.prototype.frustum=function(t,e,i,s,n,r){this.initmatrix();var a=(e+t)/(e-t),o=(s+i)/(s-i),h=-(r+n)/(r-n),u=-2*r*n/(r-n);return this.matrix.buf[0]=2*n/(e-t),this.matrix.buf[5]=2*n/(s-i),this.matrix.buf[8]=a,this.matrix.buf[9]=o,this.matrix.buf[10]=h,this.matrix.buf[11]=-1,this.matrix.buf[14]=u,this.matrix.buf[15]=0,this.multRight(this.matrix),this},e.prototype.perspective=function(t,e,i,s){var n=Math.tan(t*Math.PI/360)*i,r=-n,a=e*r,o=e*n;return this.frustum(a,o,r,n,i,s),this},e.prototype.pallarel=function(t,e,i,s){var n=t/2,r=-n,a=n/e,o=-a;return this.ortho(r,n,o,a,i,s),this},e.prototype.lookat=function(t,e,i,s,n,r,a,o,h){this.initmatrix();var u=t-s,c=e-n,l=i-r,f=Math.hypot(u,c,l);return f&&(u/=f,c/=f,l/=f),xx=o*l-h*c,xy=-a*l+h*u,xz=a*c-o*u,yx=c*xz-l*xy,yy=-u*xz+l*xx,yz=u*xy-c*xx,(f=Math.hypot(xx,xy,xz))&&(xx/=f,xy/=f,xz/=f),(f=Math.hypot(yx,yy,yz))&&(yx/=f,yy/=f,yz/=f),this.matrix.buf[0]=xx,this.matrix.buf[1]=yx,this.matrix.buf[2]=u,this.matrix.buf[4]=xy,this.matrix.buf[5]=yy,this.matrix.buf[6]=c,this.matrix.buf[8]=xz,this.matrix.buf[9]=yz,this.matrix.buf[10]=l,this.matrix.buf[12]=-(xx*t+xy*e+xz*i),this.matrix.buf[13]=-(yx*t+yy*e+yz*i),this.matrix.buf[14]=-(u*t+c*e+l*i),this.multRight(this.matrix),this},e.prototype._determinant2x2=function(t,e,i,s){return t*s-e*i},e.prototype._determinant3x3=function(t,e,i,s,n,r,a,o,h){return t*this._determinant2x2(n,r,o,h)-s*this._determinant2x2(e,i,o,h)+a*this._determinant2x2(e,i,n,r)},e.prototype._determinant4x4=function(){var t=this.buf[0],e=this.buf[1],i=this.buf[2],s=this.buf[3],n=this.buf[4],r=this.buf[5],a=this.buf[6],o=this.buf[7],h=this.buf[8],u=this.buf[9],c=this.buf[10],l=this.buf[11],f=this.buf[12],p=this.buf[13],m=this.buf[14],d=this.buf[15];return t*this._determinant3x3(r,u,p,a,c,m,o,l,d)-e*this._determinant3x3(n,h,f,a,c,m,o,l,d)+i*this._determinant3x3(n,h,f,r,u,p,o,l,d)-s*this._determinant3x3(n,h,f,r,u,p,a,c,m)},e.prototype._makeAdjoint=function(){var t=this.buf[0],e=this.buf[1],i=this.buf[2],s=this.buf[3],n=this.buf[4],r=this.buf[5],a=this.buf[6],o=this.buf[7],h=this.buf[8],u=this.buf[9],c=this.buf[10],l=this.buf[11],f=this.buf[12],p=this.buf[13],m=this.buf[14],d=this.buf[15];this.buf[0]=this._determinant3x3(r,u,p,a,c,m,o,l,d),this.buf[4]=-this._determinant3x3(n,h,f,a,c,m,o,l,d),this.buf[8]=this._determinant3x3(n,h,f,r,u,p,o,l,d),this.buf[12]=-this._determinant3x3(n,h,f,r,u,p,a,c,m),this.buf[1]=-this._determinant3x3(e,u,p,i,c,m,s,l,d),this.buf[5]=this._determinant3x3(t,h,f,i,c,m,s,l,d),this.buf[9]=-this._determinant3x3(t,h,f,e,u,p,s,l,d),this.buf[13]=this._determinant3x3(t,h,f,e,u,p,i,c,m),this.buf[2]=this._determinant3x3(e,r,p,i,a,m,s,o,d),this.buf[6]=-this._determinant3x3(t,n,f,i,a,m,s,o,d),this.buf[10]=this._determinant3x3(t,n,f,e,r,p,s,o,d),this.buf[14]=-this._determinant3x3(t,n,f,e,r,p,i,a,m),this.buf[3]=-this._determinant3x3(e,r,u,i,a,c,s,o,l),this.buf[7]=this._determinant3x3(t,n,h,i,a,c,s,o,l),this.buf[11]=-this._determinant3x3(t,n,h,e,r,u,s,o,l),this.buf[15]=this._determinant3x3(t,n,h,e,r,u,i,a,c)},e.V3add=function(){let t=0,e=0,i=0;for(let s=0;s<arguments.length;s++)t+=arguments[s][0],e+=arguments[s][1],i+=arguments[s][2];return[t,e,i]},e.V3sub=function(){let t=arguments[0][0],e=arguments[0][1],i=arguments[0][2];for(let s=1;s<arguments.length;s++)t-=arguments[s][0],e-=arguments[s][1],i-=arguments[s][2];return[t,e,i]},e.V3inv=function(t){return[-t[0],-t[1],-t[2]]},e.V3len=function(t){return Math.hypot(t[0],t[1],t[2])},e.V3norm=function(t,i){const s=e.V3len(t);return void 0===i&&(i=1),0==s?[0,0,0]:[t[0]*i/s,t[1]*i/s,t[2]*i/s]},e.V3mult=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},e.V3dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},e.V3cross=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},e.prototype.multVec4=function(t,e,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],s=t[3],t=t[0]);var n=this.buf[0]*t+this.buf[4]*e+this.buf[8]*i+this.buf[12]*s,r=this.buf[1]*t+this.buf[5]*e+this.buf[9]*i+this.buf[13]*s,a=this.buf[2]*t+this.buf[6]*e+this.buf[10]*i+this.buf[14]*s,o=this.buf[3]*t+this.buf[7]*e+this.buf[11]*i+this.buf[15]*s;return[n,r,a,o]},e.rotAndTrans=function(t,i,s,n,r,a){var o=new e;return 0!=t&&o.rotate(t,1,0,0),0!=i&&o.rotate(i,0,1,0),0!=s&&o.rotate(s,0,0,1),o.translate(n,r,a),o},e.prototype.q2m=function(t,e,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(e=t[1],i=t[2],s=t[3],t=t[0]);var n=t*t,r=e*e,a=i*i;return this.buf[0]=1-2*(r+a),this.buf[1]=2*(t*e+s*i),this.buf[2]=2*(t*i-s*e),this.buf[3]=0,this.buf[4]=2*(t*e-s*i),this.buf[5]=1-2*(n+a),this.buf[6]=2*(e*i+s*t),this.buf[7]=0,this.buf[8]=2*(t*i+s*e),this.buf[9]=2*(e*i-s*t),this.buf[10]=1-2*(n+r),this.buf[11]=0,this.buf[12]=0,this.buf[13]=0,this.buf[14]=0,this.buf[15]=1,this},e.v2q=function(t,i,s,n){(Array.isArray(i)||i instanceof Float32Array)&&(s=i[1],n=i[2],i=i[0]);let r=i*i+s*s+n*n;if(0==r)return[0,0,0,1];1!=r&&(r=Math.sqrt(r),i/=r,s/=r,n/=r),t=t*e.RAD/2;let a=Math.sin(t);return[i*a,s*a,n*a,Math.cos(t)]},e.e2q=function(t,i,s){(Array.isArray(t)||t instanceof Float32Array)&&(i=t[1],s=t[2],t=t[0]),t*=.5*e.RAD,i*=.5*e.RAD,s*=.5*e.RAD;let n=Math.cos(t),r=Math.cos(i),a=Math.cos(s),o=Math.sin(t),h=Math.sin(i),u=Math.sin(s),c=o*r*a+n*h*u,l=n*h*a-o*r*u,f=n*r*u-o*h*a,p=n*r*a+o*h*u;return[c,l,f,p]},e.qMult=function(t,e){let i=t[3]*e[3]-(t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),s=t[1]*e[2]-t[2]*e[1]+t[3]*e[0]+e[3]*t[0],n=t[2]*e[0]-t[0]*e[2]+t[3]*e[1]+e[3]*t[1],r=t[0]*e[1]-t[1]*e[0]+t[3]*e[2]+e[3]*t[2];return[s,n,r,i]},t.CanvasMatrix4=e}),t("skylark-pox/Vector",["./pox"],function(t){class e extends Array{constructor(...t){let e=t;Array.isArray(t[0])&&(e=t[0]),super(...e),this._setxyz()}_setxyz(){this.x=this[0],void 0!==this[1]&&(this.y=this[1]),void 0!==this[2]&&(this.z=this[2]),void 0!==this[3]&&(this.w=this[3])}set x(t){this._x=t,this[0]=t}set y(t){this._y=t,this[1]=t}set z(t){this._z=t,this[2]=t}set w(t){this._w=t,this[3]=t}set r(t){this._x=t,this[0]=t}set g(t){this._y=t,this[1]=t}set b(t){this._z=t,this[2]=t}set a(t){this._w=t,this[3]=t}get x(){return this._x}get y(){return this._y}get z(){return this._z}get w(){return this._w}get r(){return this._x}get g(){return this._y}get b(){return this._z}get a(){return this._w}get xy(){return new e(this[0],this[1])}get yx(){return new e(this[1],this[0])}get xz(){return new e(this[0],this[2])}get zx(){return new e(this[2],this[0])}get yz(){return new e(this[1],this[2])}get zy(){return new e(this[2],this[1])}get xyz(){return new e(this[0],this[1],this[2])}get xzy(){return new e(this[0],this[2],this[1])}get yxz(){return new e(this[1],this[0],this[2])}get yzx(){return new e(this[1],this[2],this[0])}get zxy(){return new e(this[2],this[0],this[1])}get zyx(){return new e(this[2],this[1],this[0])}get rgb(){return new e(this[0],this[1],this[2])}cross(t){if(3!=this.length||3!=t.length)throw-1;let i=[this[1]*t[2]-this[2]*t[1],this[2]*t[0]-this[0]*t[2],this[0]*t[1]-this[1]*t[0]];return new e(i)}mix(t,i){return new e(this.map((e,s)=>e*(1-i)+t[s]*i))}invert(){return new e(this.map(t=>-t))}add(t){if(Array.isArray(t)||(t=new Array(this.length).fill(t)),this.length!=t.length)throw-1;return new e(this.map((e,i)=>e+t[i]))}sub(t){if(Array.isArray(t)||(t=new Array(this.length).fill(t)),this.length!=t.length)throw-1;return new e(this.map((e,i)=>e-t[i]))}mult(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e*t[i]))}normalize(){let t=this.hypot();return new e(this.map((e,i)=>0!=t?e/t:0))}floor(){return new e(this.map((t,e)=>Math.floor(t)))}ceil(){return new e(this.map((t,e)=>Math.ceil(t)))}fract(){return new e(this.map((t,e)=>t-Math.floor(t)))}min(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e<t[i]?e:t[i]))}max(t){return Array.isArray(t)||(t=new Array(this.length).fill(t)),new e(this.map((e,i)=>e>t[i]?e:t[i]))}clamp(t,i){return new e(this.map((e,s)=>e<t?t:e>i?i:e))}step(t){return new e(this.map((e,i)=>e<t?0:1))}mod(t){return new e(this.map((e,i)=>e%t))}dot(t){return this.reduce((e,i,s)=>e+=i*t[s],0)}distance(t){let i=new e(...this);return i.sub(t).hypot()}hypot(){return Math.hypot(...this)}equal(t){return this.reduce((e,i,s)=>e&&i===t[s],!0)}}return t.Vector=e}),t("skylark-pox/Device",["./pox","./Vector"],function(t,e){const i={VRReady:!1,isPresenting:!1,WebXR:!1,checkVR:function(t){return new Promise((e,s)=>{navigator.xr?navigator.xr.isSessionSupported("immersive-vr").then(t=>{i.VRReady=t,i.WebXR=t,e(t)}).catch(t=>{console.log(t),e(!1)}):navigator.getVRDisplays?(void 0!=window.VRFrameData&&(i.vrFrame=new VRFrameData),navigator.getVRDisplays().then(s=>{console.log("VR init with WebVR"),i.vrDisplay=s[s.length-1],console.log(i.vrDisplay),i.VRReady=!0,window.addEventListener("vrdisplaypresentchange",()=>{console.log("vr presenting= "+i.vrDisplay.isPresenting),i.vrDisplay.isPresenting?(t.callEvent("vrchange",1),i.isPresenting=!0):(t.resize(),t.callEvent("vrchange",0),i.isPresenting=!1)},!1),window.addEventListener("vrdisplayactivate",()=>{console.log("vr active")},!1),window.addEventListener("vrdisplaydeactivate",()=>{console.log("vr deactive")},!1),e(!0)}).catch(t=>{s(t)})):e(!1)})},presentVR:function(t){return new Promise((e,s)=>{if(i.WebXR)navigator.xr.requestSession("immersive-vr").then(function(e){i.session=e,i.isPresenting=!0,console.log("vr start"),e.updateRenderState({baseLayer:new XRWebGLLayer(e,t.wwg.gl,{framebufferScaleFactor:t.pixRatio})}),e.requestReferenceSpace("local").then(e=>{i.referenceSpace=e,i.session.requestAnimationFrame(i.loopf),t.callEvent("vrchange",1)}),e.addEventListener("end",e=>{i.session=null,i.isPresenting=!1,console.log("VR end"),t.callEvent("vrchange",0)})});else if(i.vrDisplay){const e={source:t.can,attributes:{}};void 0!==t.pox.setting.highRefreshRate&&(e.attributes.highRefreshRate=t.pox.setting.highRefreshRate),void 0!==t.pox.setting.foveationLevel&&(e.attributes.foveationLevel=t.pox.setting.foveationLevel),i.vrDisplay.requestPresent([e]).then(()=>{console.log("present ok");const e=i.vrDisplay.getEyeParameters("left"),s=i.vrDisplay.getEyeParameters("right");t.can.width=2*Math.max(e.renderWidth,s.renderWidth),t.can.height=Math.max(e.renderHeight,s.renderHeight),"Oculus Go"==i.vrDisplay.displayName&&(t.can.width=2560,t.can.height=1280),t.can.width=t.can.width*t.pixRatio,t.can.height=t.can.height*t.pixRatio,t.pox.log(i.vrDisplay.displayName),t.pox.log("vr canvas:"+t.can.width+" x "+t.can.height)}).catch(t=>{console.log(t)})}})},closeVR:function(t){i.WebXR&&(console.log("vr closing"),i.isPresenting=!1,i.session.end()),i.vrDisplay&&i.vrDisplay.exitPresent().then(()=>{console.log("VR end")})},animationFrame:function(t,e,s){if(i.loopf=e,i.isPresenting){if(!s)return;i.WebXR?(i.session.requestAnimationFrame(e),i.vrFrame=s,t.isVR=!0):i.vrDisplay&&i.vrDisplay.isPresenting&&(t.loop=i.vrDisplay.requestAnimationFrame(e),t.isVR=!0)}else t.loop=window.requestAnimationFrame(e),t.isVR=!1},submitFrame:function(t){i.WebXR,i.vrDisplay&&i.vrDisplay.isPresenting&&i.vrDisplay.submitFrame()},getFrameData:function(t){if(i.WebXR&&i.vrFrame){let t=i.vrFrame.getViewerPose(i.referenceSpace);t.orientation=[t.transform.orientation.x,t.transform.orientation.y,t.transform.orientation.z,t.transform.orientation.w],t.position=[t.transform.position.x,t.transform.position.y,t.transform.position.z];let s={pose:t},n=i.session.renderState.baseLayer;i.webGLLayer=n;for(let i=0;i<=t.views.length-1;i++){var e=n.getViewport(t.views[i]);1==i?(s.rightViewMatrix=t.views[i].transform.inverse.matrix,s.rightProjectionMatrix=t.views[i].projectionMatrix,s.rightViewport=e):(s.leftViewMatrix=t.views[i].transform.inverse.matrix,s.leftProjectionMatrix=t.views[i].projectionMatrix,s.leftViewport=e)}return i.viewport={leftViewport:s.leftViewport,rightViewport:s.rightViewport},s}if(i.vrDisplay)return i.vrDisplay.getFrameData(i.vrFrame),i.vrFrame},getViewport:function(t){return i.WebXR&&i.isPresenting?i.viewport:{leftViewport:{x:0,y:0,width:t.width/2,height:t.height},rightViewport:{x:t.width/2,y:0,width:t.width/2,height:t.height}}},setDepth:function(t){i.isPresenting&&(i.WebXR&&i.session.updateRenderState({depthNear:t.camNear,depthFar:t.camFar}),i.vrDisplay&&(i.vrDisplay.depthNear=t.camNear,i.vrDisplay.depthFar=t.camFar))}};return t.Device=i}),t("skylark-pox/GPad",["./pox","./Device"],function(t,e){var i=function(){return this.idx=0,this.conn=!1,this.gpadcount=0,!!navigator.getGamepads&&(gamepads=navigator.getGamepads(),this.gpadcount=gamepads.length,this.gpadcount>0)};return i.prototype.init=function(t,e){if(void 0==t&&(t=0),this.idx=t,!navigator.getGamepads)return!1;let i=!0;return gamepads=navigator.getGamepads(),gamepads[this.idx]?(console.log("gpad init "+this.idx),this.axes=gamepads[this.idx].axes,this.conn=!1,this.egp=null):(this.conn=!1,i=!1),addEventListener("gamepadconnected",t=>{t.gamepad.index==this.idx&&(console.log("gpad reconnected "+t.gamepad.index),this.axes=t.gamepad.axes,this.conn=!0,this.get(),e&&e(this,!0))}),addEventListener("gamepaddisconnected",t=>{t.gamepad.index==this.idx&&(console.log("gpad disconnected "+t.gamepad.index),this.conn=!1,e&&e(this,!1))}),this.lastGp={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0]},this.egp={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0]},i},i.prototype.get=function(t){var i;if(e&&e.WebXR)if(this.emu=!1,e.isPresenting&&e.session.inputSources){const t=e.session.inputSources;for(let s=0;s<=t.length-1;s++)if(t[s].gamepad&&"xr-standard"==t[s].gamepad.mapping){if(t[s].gamepad.hand=t[s].handedness,"left"==t[s].handedness&&1==this.idx&&(i=t[s].gamepad),"right"==t[s].handedness&&0==this.idx&&(i=t[s].gamepad),i){let n=e.vrFrame.getPose(t[s].gripSpace,e.referenceSpace);n&&(i.pose={},n.transform.orientation&&(i.pose.orientation=[n.transform.orientation.x,n.transform.orientation.y,n.transform.orientation.z,n.transform.orientation.w]),n.transform.position&&(i.pose.position=[n.transform.position.x,n.transform.position.y,n.transform.position.z])),this.conn=!0;break}this.conn=!1}}else this.conn=!1;if(!i){if(null==this.egp)return null;this.conn=!0,i=this.egp,this.emu=!0}var s=this.lastGp;i.conn=this.conn,i.emu=this.emu,i.bf=!1,i.pf=!1,i.tf=!1,i.dbtn=[],i.dpad=[],i.dtouch=[];for(var n=0;n<i.buttons.length;n++)i.dbtn[n]=0,i.dtouch[n]=0,s&&s.buttons[n]&&(!s.buttons[n].pressed&&i.buttons[n].pressed&&(i.dbtn[n]=1,i.bf=!0),s.buttons[n].pressed&&!i.buttons[n].pressed&&(i.dbtn[n]=-1,i.bf=!0),!s.buttons[n].touched&&i.buttons[n].touched&&(i.dtouch[n]=1,i.tf=!0),s.buttons[n].touched&&!i.buttons[n].touched&&(i.dtouch[n]=-1,i.tf=!0)),s.buttons[n]={pressed:i.buttons[n].pressed,touched:i.buttons[n].touched};let r=[i.axes[0],i.axes[1],i.axes[2],i.axes[3]];void 0!==i.axes[2]&&void 0!==i.axes[3]?(r[0]=i.axes[2],r[1]=i.axes[3],i.stick=!0):i.stick=!1,i.eaxes=r;for(var n=0;n<r.length;n++)Math.abs(r[n])<.001&&(i.axes[n]=0),i.dpad[n]=0,s&&(Math.abs(s.axes[n])<.5&&Math.abs(r[n])>=.5&&(i.dpad[n]=1,i.pf=!0),Math.abs(s.axes[n])>=.5&&Math.abs(r[n])<.5&&(i.dpad[n]=-1,i.pf=!0)),s.axes[n]=r[n];return this.gp=i,this.ev&&(i.bf||i.pf||i.tf)&&this.ev(i),i},i.prototype.set=function(t){this.egp=t},i.prototype.clear=function(t){void 0==t&&(t={buttons:[{pressed:!1,touched:!1},{pressed:!1,touched:!1}],axes:[0,0]}),this.egp=t,this.cf=!0},t.GPad=i}),t("skylark-pox/Pointer",["./pox"],function(t){return t.Pointer=function(t,e){var i,s,n,r,a,o=this;function h(t){var e,s;return i&&t.touches.length>0?(e=t.touches[0].pageX-t.target.offsetLeft,s=t.touches[0].pageY-t.target.offsetTop):(e=t.offsetX,s=t.offsetY),{x:e,y:s}}function u(u){s||(n||(i="touchstart"==u.type,function(){i?(n="touchstart",r="touchend",EV_O="touchcancel",a="touchmove"):(n="mousedown",r="mouseup",EV_O="mouseout",a="mousemove");t.addEventListener(r,function(t){var i=h(t),s="touchend"==t.type?o.lastd:h(t);o.mf=!1,e.up&&(e.up({x:i.x,y:i.y,ex:s.x,ey:s.y,dx:o.dx,dy:o.dy})||t.preventDefault())},!1),t.addEventListener(EV_O,function(t){o.mf=!1;var i=h(t);e.out&&(e.out({x:i.x,y:i.y,dx:o.dx,dy:o.dy})||t.preventDefault())},!1),t.addEventListener(a,function(t){if(!s){var i=h(t);o.lastd=i,o.mf&&(o.dx=i.x-o.s.x,o.dy=i.y-o.s.y,e.move&&(e.move({x:i.x,y:i.y,ox:i.x,oy:i.y,dx:o.dx,dy:o.dy})||t.preventDefault()))}},!1)}(),first=!1),o.mf=!0,o.dx=o.dy=0,o.s=h(u),o.lastd=o.s,e.down&&(e.down({x:o.s.x,y:o.s.y,sx:o.s.x,sy:o.s.y})||u.preventDefault()))}t.addEventListener("mousedown",u,!1),t.addEventListener("touchstart",u,!1),e.contextmenu&&t.addEventListener("contextmenu",function(t){e.contextmenu({px:t.offsetX,py:t.offsetY})||t.preventDefault()},!1);e.wheel&&t.addEventListener("wheel",function(t){e.wheel(t.deltaY)||t.preventDefault()},!1);e.gesture&&(t.addEventListener("gesturestart",function(t){s=!0,e.gesture(0,0)||t.preventDefault()}),t.addEventListener("gesturechange",function(t){e.gesture(t.scale,t.rotation)||t.preventDefault()}),t.addEventListener("gestureend",function(t){s=!1}));e.gyro&&window.addEventListener("deviceorientation",function(t){var i,s,n,r=window.orientation;switch(i=null,s=null,n=null,r){case 90:t.gamma<0?(i=t.gamma+90,s=180-t.alpha,n=t.beta+180):(i=t.gamma-90,s=360-t.alpha,n=t.beta);break;case-90:t.gamma<0?(i=-t.gamma-90,s=180-t.alpha,n=180-t.beta):(i=90-t.gamma,s=360-t.alpha,n=-t.beta)}e.gyro({rx:i,ry:s,rz:n,orientation:r})})}}),t("skylark-pox/Camera",["./pox","./CanvasMatrix4"],function(t,e){const i=t.RAD,s=e;return t.Camera=class{constructor(t,i){this.poxp=t,this.cam={camCX:0,camCY:0,camCZ:0,camVX:0,camVY:0,camVZ:1,camUPX:0,camUPY:1,camUPZ:0,camRX:30,camRY:-30,camRZ:0,camd:20,camAngle:90,camWidth:1,camNear:.01,camFar:1e3,camGyro:!0,gPad:!0,sbase:.06,moveSpeed:1.3,rotAngle:30,moveY:!1,padMoveUD:!0,padRot:!0,headVec:[0,0,0]};for(let t in i)this.cam[t]=i[t];this.cama=!1,this.rotX=0,this.rotY=0,this.gev=null,this.gx=0,this.gy=0,this.gz=0,this.vcx=0,this.vcy=0,this.vcz=0,this.vrx=0,this.vry=0,this.vrz=0,this.keydown=!1,this.vr=!1,this.camVP=[new e,new e],this.camP=[new e,new e],this.camV=[new e,new e],this.vrv=[new e,new e],this.vrp=[new e,new e],this.tempM=new e,this.pvy=!1,this.pvx=!1}setCam(t){for(let e in t)this.cam[e]=t[e];this.cama=!1}getCam(){const t={basePos:[this.cam.camCX,this.cam.camCY,this.cam.camCZ],baseRot:[this.cam.camRX,this.cam.camRY,this.cam.camRZ],position:Array.from(this.cam.campos),headVec:Array.from(this.cam.headVec)};return this.cam.orientation?t.headOri=Array.from(this.cam.orientation):t.headOri=[0,0,0,1],this.cam.position?t.headPos=Array.from(this.cam.position):t.headPos=[0,0,0],t}vrchange(t){t&&(this.cam.camRX=0,this.cam.camRZ=0)}event(t,e){const s=300*this.poxp.pixRatio/this.poxp.can.width,n=this.poxp.pox.setting&&this.poxp.pox.setting.scale?this.poxp.pox.setting.scale:1;switch(t){case"down":this.rotX=this.cam.camRX,this.rotY=this.cam.camRY;break;case"move":this.cam.camRX=this.rotX+e.dy*s,this.cam.camRY=this.rotY+e.dx*s,this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRX<-89&&(this.cam.camRX=-89);break;case"up":this.rotX+=e.dy*s,this.rotY+=e.dx*s,null!==this.gev&&(this.gx=this.gev.rx-this.rotX,this.gy=this.gev.ry-this.rotY);break;case"out":this.rotX+=e.dy*s,this.rotY+=e.dx*s;break;case"wheel":this.cam.camd+=e/100*n;break;case"gesture":if(0==e.z)return this.gz=this.cam.camd,!1;this.cam.camd=this.gz/e.z;break;case"gyro":if(this.keydown||!this.cam.camGyro)return!0;if(null===e.rx)return!0;this.gev=e,this.cam.camRX=e.rx-this.gx,this.cam.camRY=e.ry-this.gy,this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRX<-89&&(this.cam.camRX=-89);break;case"keydown":this.cam.camd;const r=this.cam.moveSpeed;let a="";if(this.keydown=!0,e.altKey)switch(e.key){case"ArrowUp":this.cam.camd=this.cam.camd-r,this.cam.camd<0&&(cthis.am.camd=0);break;case"ArrowDown":this.cam.camd=this.cam.camd+r}else switch(e.key){case"ArrowLeft":case"Left":case"h":this.vry=-r;break;case"ArrowUp":case"Up":case"k":this.vrx=-r;break;case"ArrowRight":case"Right":case"l":this.vry=r;break;case"ArrowDown":case"Down":case"j":this.vrx=r;break;case"w":a="f";break;case"s":a="b";break;case"a":a="l";break;case"d":a="r";break;case"q":a="u";break;case"e":a="d"}if(""!=a){const t=("b"==a||"d"==a?-1:1)*r*n,e=this.cam;if("u"==a||"d"==a)this.vcy=t;else{let s=e.camRY;"l"==a&&(s-=90),"r"==a&&(s+=90),this.vcx=Math.sin(s*i)*t,this.vcz=-Math.cos(s*i)*t}}break;case"keyup":switch(this.keydown=!1,null!==this.gev&&(this.gx=this.gev.rx-this.cam.camRX,this.gy=this.gev.ry-this.cam.camRY),e.key){case"ArrowLeft":case"Left":case"h":case"ArrowRight":case"Right":case"l":this.vry=0;break;case"ArrowUp":case"Up":case"k":case"ArrowDown":case"Down":case"j":this.vrx=0;break;case"w":case"d":case"a":case"s":case" ":this.vcx=0,this.vcz=0;break;case"q":case"e":this.vcy=0;break;case"Dead":this.vrx=0,this.vry=0,this.vcx=0,this.vcz=0}}}update(t){const e=(this.poxp.ctime-this.poxp.ltime)/1e3;"fix"!=this.cam.camMode&&(this.cam.camRX+=this.vrx,this.cam.camRX<-89&&(this.cam.camRX=-89),this.cam.camRX>89&&(this.cam.camRX=89),this.cam.camRY+=this.vry),"walk"==this.cam.camMode&&(this.cama||(this.cam.camCX+=this.vcx*e,this.cam.camCY+=this.vcy*e,this.cam.camCZ+=this.vcz*e),this.cam.camRY+=this.vry*e),this.cama&&(this.cam.camCX+=this.acx*e,this.cam.camCY+=this.acy*e,this.cam.camCZ+=this.acz*e,this.ad+=this.av*e,this.ad>this.al&&(this.cam.camCX=this.aex,this.cam.camCY=this.aey,this.cam.camCZ=this.aez,this.cama=!1))}setPad(t,e){let i=t||e;if(i&&"walk"==this.cam.camMode){let t=[i.axes[0],i.axes[1]];if(void 0!=i.axes[2]&&0!=i.axes[2]&&(t[0]=i.axes[2]),void 0!=i.axes[3]&&0!=i.axes[3]&&(t[1]=i.axes[3]),this.cam.padMoveUD&&i.buttons[1]&&i.buttons[1].pressed)return this.vcy=-t[1]*this.cam.moveSpeed,void(this.pvy=!0);this.pvy&&(this.vcy=0,this.pvy=!1);let e=i.buttons[2]&&i.buttons[2].pressed,s=e?5*this.cam.moveSpeed:this.cam.moveSpeed;if(Math.abs(t[0])<Math.abs(t[1])&&Math.abs(t[1])>0)return this.vcx=-this.cam.headVec[0]*t[1]*s,this.cam.moveY&&(this.vcy=-this.cam.headVec[1]*t[1]*s),this.vcz=-this.cam.headVec[2]*t[1]*s,void(this.pvx=!0);if(this.pvx&&(this.vcx=0,this.vcy=0,this.vcz=0,this.pvx=!1),this.cam.padRot&&i.dpad[0]>0){let e=(t[0]>0?1:-1)*this.cam.rotAngle;this.cam.camRY+=e}}}moveTo(t,e,i,s){if(this.cama)return;let n=null!==t?t:this.cam.camCX,r=null!==e?e:this.cam.camCY,a=null!==i?i:this.cam.camCZ;if(s&&s.velocity){let t=n-this.cam.camCX,e=r-this.cam.camCY,i=a-this.cam.camCZ,o=s.velocity/Math.hypot(t,e,i);t*=o,e*=o,i*=o,this.acx=t,this.acy=e,this.acz=i,this.aex=n,this.aey=r,this.aez=a,this.al=s.velocity/o,this.ad=0,this.av=s.velocity,this.cama=!0}else this.cam.camCX=n,this.cam.camCY=r,this.cam.camCZ=a,this.cama=!1}moveCancel(){this.cama=!1}getMtx(t,e){const n=this.cam,r=this.poxp.render.wwg.can,a=r.width/(r.height*(e?2:1));let o,h,u,c,l,f,p,m,d,b,v=null;if(p=n.camUPX,m=n.camUPY,d=n.camUPZ,c=[0,0],l=[0,0],f=[0,0],!this.poxp.isVR){if("fix"==n.camMode)o=n.camVX,h=n.camVY,u=n.camVZ,this.cam.headVec=[o,h,u,0];else if("vr"==n.camMode||"walk"==n.camMode){o=n.camCX+1*Math.sin(n.camRY*i)*Math.cos(n.camRX*i),h=n.camCY+1*-Math.sin(n.camRX*i),u=n.camCZ+1*-Math.cos(n.camRY*i)*Math.cos(n.camRX*i);let t=(new s).rotate(-this.cam.camRX,1,0,0).rotate(-this.cam.camRY,0,1,0).rotate(-this.cam.camRZ,0,0,1);p=-Math.sin(n.camRZ*i),m=Math.cos(n.camRZ*i),this.cam.headVec=t.multVec4(0,0,-1,0)}else{b=n.camd*t,n.camCX=-Math.sin(n.camRY*i)*b*Math.cos(n.camRX*i),n.camCY=Math.sin(n.camRX*i)*b,n.camCZ=Math.cos(n.camRY*i)*b*Math.cos(n.camRX*i),o=0,h=0,u=0,b<0&&(o=2*n.camCX,h=2*n.camCY,u=2*n.camCZ);let e=Math.hypot(n.camCX,n.camCY,n.camCZ);this.cam.headVec=[-n.camCX/e,-n.camCY/e,-n.camCZ/e,0]}if(this.cam.campos=[n.camCX,n.camCY,n.camCZ],this.camVP[0].makeIdentity(),this.camVP[1].makeIdentity(),this.camP[0].makeIdentity(),this.camP[1].makeIdentity(),this.camV[0].makeIdentity(),this.camV[1].makeIdentity(),e){const e=-n.sbase*t;c[0]=m*(n.camCZ-u)-d*(n.camCY-h),l[0]=-p*(n.camCZ-u)+d*(n.camCX-o),f[0]=p*(n.camCY-h)-m*(n.camCX-o);const i=Math.hypot(c[0],l[0],f[0]);c[0]*=e/i,l[0]*=e/i,f[0]*=e/i,c[1]=-c[0],l[1]=-l[0],f[1]=-f[0],this.camV[0].lookat(c[0]+n.camCX,l[0]+n.camCY,f[0]+n.camCZ,o+c[0],h+l[0],u+f[0],p,m,d),this.camV[1].lookat(c[1]+n.camCX,l[1]+n.camCY,f[1]+n.camCZ,o+c[1],h+l[1],u+f[1],p,m,d),0!=n.camAngle?this.camP[0].perspective(n.camAngle,a,n.camNear,n.camFar):this.camP[0].pallarel(n.camd,a,n.camNear,n.camFar),this.camP[1]=this.camP[0],this.camVP[0].load(this.camV[0]).multRight(this.camP[0]),this.camVP[1].load(this.camV[1]).multRight(this.camP[1])}else this.camV[0].lookat(n.camCX,n.camCY,n.camCZ,o,h,u,p,m,d),0!=n.camAngle?this.camP[0].perspective(n.camAngle,a,n.camNear,n.camFar):this.camP[0].pallarel(n.camd,a,n.camNear,n.camFar),this.camVP[0].load(this.camV[0]).multRight(this.camP[0])}if(this.poxp.isVR){if(POXPDevice.setDepth({camNear:n.camNear,camFar:n.camFar}),!(v=POXPDevice.getFrameData()))return;this.cam.orientation=v.pose.orientation,this.cam.position=v.pose.position,this.cam.position||(this.cam.position=[0,0,0]),this.vrv[1].load(v.rightViewMatrix),this.vrv[0].load(v.leftViewMatrix),this.vrp[1].load(v.rightProjectionMatrix),this.vrp[0].load(v.leftProjectionMatrix),this.tempM.makeIdentity().translate(-n.camCX,-n.camCY,-n.camCZ).rotate(n.camRX,1,0,0).rotate(n.camRY,0,1,0).rotate(n.camRZ,0,0,1),this.camV[0].load(this.vrv[0]),this.leftCorrMtx&&this.camV[0].multRight(this.leftCorrMtx),this.camV[0].multLeft(this.tempM),this.camVP[0].load(this.camV[0]).multRight(this.vrp[0]),this.camP[0].load(this.vrp[0]),this.camV[1].load(this.vrv[1]),this.rightCorrMtx&&this.camV[1].multRight(this.rightCorrMtx),this.camV[1].multLeft(this.tempM),this.camVP[1].load(this.camV[1]).multRight(this.vrp[1]),this.camP[1].load(this.vrp[1]);let t=0,e=0,i=1;if(this.cam.orientation){let s=this.cam.orientation[0],n=this.cam.orientation[1],r=this.cam.orientation[2],a=this.cam.orientation[3];t=2*(-s*r-n*a),e=2*(-n*r+s*a),i=s*s+n*n-r*r-a*a;let o=Math.hypot(t,e,i);t/=o,e/=o,i/=o}this.tempM.invert();let r=this.tempM;this.cam.headVec=r.multVec4(t,e,i,0),this.cam.campos=r.multVec4(this.cam.position[0],this.cam.position[1],this.cam.position[2],1).slice(0,3);let a=(new s).load(this.camV[1]).invert(),o=(new s).load(this.camV[0]).invert();c[0]=o.buf[12]-n.camCX,l[0]=o.buf[13]-n.camCY,f[0]=o.buf[14]-n.camCZ,c[1]=a.buf[12]-n.camCX,l[1]=a.buf[13]-n.camCY,f[1]=a.buf[14]-n.camCZ}return[{camX:n.camCX+c[0],camY:n.camCY+l[0],camZ:n.camCZ+f[0],camV:this.camV[0],camVP:this.camVP[0],camP:this.camP[0],vrFrame:v},{camX:n.camCX+c[1],camY:n.camCY+l[1],camZ:n.camCZ+f[1],camV:this.camV[1],camVP:this.camVP[1],camP:this.camP[1],vrFrame:v}]}}}),t("skylark-pox/WBind",["./pox"],function(t){return WBind={},WBind.create=function(t){var e=new WBind.obj;if(void 0!==t)for(var i in t)e[i]=t[i];return e},WBind.obj=function(){this.prop={},this._elem={},this._check={},this._func={},this._tobjs={}},WBind._getobj=function(t,e){var i;return e||(e=document),"string"==typeof t?(1==(i=e.querySelectorAll(t)).length&&(i=i[0]),0==i.length&&(i=null)):i=t,i},WBind._getval=function(t){var e=t.value;if("checkbox"==t.type&&(e=t.checked),"select-multiple"==t.type){var i=t.querySelectorAll("option");e=[];for(var s=0;s<i.length;s++)i[s].selected&&e.push(i[s].value)}return"range"==t.type&&(e=parseFloat(e)),e},WBind.obj.prototype.bindHtml=function(t,e,i){var s=WBind._getobj(e);return s?(this._elem[t]=s,i||(i={}),this._func[t]=i,Object.defineProperty(this,t,{configurable:!0,get:function(){return s instanceof NodeList||Array.isArray(s)?this.prop[t]=s[0].innerHTML:this.prop[t]=s.innerHTML,this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,s instanceof NodeList||Array.isArray(s))for(var i=0;i<s.length;i++)this._elem[t][i].innerHTML=e;else this._elem[t].innerHTML=e}}),s instanceof NodeList||Array.isArray(s)?this.prop[t]=s[0].innerHTML:this.prop[t]=s.innerHTML,this):this},WBind.obj.prototype.bindStyle=function(t,e,i,s){var n=WBind._getobj(e);return n?(this._elem[t]=n,s||(s={}),this._func[t]=s,Object.defineProperty(this,t,{configurable:!0,get:function(){return n instanceof NodeList||Array.isArray(n)?this.prop[t]=n[0].style[i]:this.prop[t]=n.style[i],this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,n instanceof NodeList||Array.isArray(n))for(var s=0;s<n.length;s++)this._elem[t][s].style[i]=e;else this._elem[t].style[i]=e}}),n instanceof NodeList||Array.isArray(n)?this.prop[t]=n[0].style[i]:this.prop[t]=n.style[i],this):this},WBind.obj.prototype.bindAttr=function(t,e,i,s){var n=WBind._getobj(e);return n?(this._elem[t]=n,s||(s={}),this._func[t]=s,Object.defineProperty(this,t,{configurable:!0,get:function(){return n instanceof NodeList||Array.isArray(n)?this.prop[t]=n[0].getAttribute(i):this.prop[t]=n.getAttribute(i),this.prop[t]},set:function(e){if(this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,n instanceof NodeList||Array.isArray(n))for(var s=0;s<n.length;s++)this._elem[t][s].setAttribute(i,e);else this._elem[t].setAttribute(i,e)}}),n instanceof NodeList||Array.isArray(n)?this.prop[t]=n[0].getAttribute(i):this.prop[t]=n.getAttribute(i),this):this},WBind.obj.prototype.bindInput=function(t,e,i){var s=WBind._getobj(e);if(!s)return this;i||(i={}),this._func[t]=i,(s instanceof NodeList||Array.isArray(s))&&"checkbox"!=s[0].type&&"radio"!=s[0].type&&(s=s[0]);var n=void 0!=this.prop[t];this._elem[t]=s,Object.defineProperty(this,t,{configurable:!0,get:function(){var e=h(t);return this._func[t].get&&(e=this._func[t].get(e)),e},set:function(e){this._func[t].set&&(e=this._func[t].set(e)),this.prop[t]=e,function(t,e){var i=r._elem[t];if(i instanceof NodeList||Array.isArray(i)){if("radio"==i[0].type)for(var s=0;s<i.length;s++)i[s].value==e&&(i[s].checked=!0);else if("checkbox"==i[0].type){for(var n={},s=0;s<e.length;s++)n[e[s]]=!0;for(var s=0;s<i.length;s++)i[s].checked=n[i[s].value];r._check[t]=n}}else if("checkbox"==i.type)i.checked=e;else if("select-multiple"==i.type)for(var a=i.querySelectorAll("option"),s=0;s<a.length;s++){a[s].selected=!1;for(var o=0;o<e.length;o++)a[s].value==e[o]&&(a[s].selected=!0)}else i.value=e}(t,e),this._func[t].change&&this._func[t].change(h(t)),this._func[t].input&&this._func[t].input(h(t))}});var r=this,a=null;if(s instanceof NodeList||Array.isArray(s)){"checkbox"==s[0].type&&(r._check[t]={});for(var o=0;o<s.length;o++)"object"==typeof s[o]&&(n||s[o].addEventListener("change",function(e){var i;"checkbox"==this.type?(r._check[t][this.value]=this.checked,i=h(t)):i=this.value,r.prop[t]=i,r._func[t].get&&(i=r._func[t].get(i)),WBind.log("get "+t+"="+i),r._func[t].change&&r._func[t].change(i)}),"radio"==s[o].type&&s[o].checked?a=s[o].value:"checkbox"==s[o].type&&(r._check[t][s[o].value]=s[o].checked));"checkbox"==s[0].type&&(a=h(t))}else a=WBind._getval(s),n||s.addEventListener("change",function(e){var i=WBind._getval(this);r.prop[t]=i,r._func[t].get&&(i=r._func[t].get(i)),r._func[t].change&&r._func[t].change(i)}),n||s.addEventListener("input",function(e){var i=WBind._getval(this);r.prop[t]=i,r._func[t].get&&(i=r._func[t].get(i)),r._func[t].input&&r._func[t].input(i)});function h(t){var e;if(r._check[t]){for(var i in e=[],r._check[t])r._check[t][i]&&e.push(i);r.prop[t]=e}else e=r.prop[t];return e}return this._func[t].get&&(a=this._func[t].get(a)),this.prop[t]=a,r._func[t].input&&this._func[t].input(a),r._func[t].change&&this._func[t].change(a),this},WBind.obj.prototype.getCheck=function(t){return this._check[t]},WBind.obj.prototype.setFunc=function(t,e){for(var i in e)this._func[t][i]=e[i];var s=WBind._getval(this._elem[t]);return this._func[t].get&&(s=this._func[t].get(s)),this.prop[t]=s,this._func[t]},WBind.obj.prototype.bindAllInput=function(t){t||(t=document);for(var e=t.querySelectorAll("input,select,textarea"),i={},s=0;s<e.length;s++){var n=e[s].name;i[n]?Array.isArray(i[n])?i[n].push(e[s]):i[n]=[i[n],e[s]]:i[n]=e[s]}for(var s in i)this.bindInput(s,i[s]);return i},WBind.obj.prototype.bindAll=function(t,e){null==e&&(e=document);for(var i=e.querySelectorAll(t),s=0;s<i.length;s++){var n=i[s].getAttribute("data-bind");"INPUT"==i[s].tagName||"SELECT"==i[s].tagName?this.bindInput(n,i[s]):this.bindHtml(n,i[s])}},WBind.obj.prototype.setTimer=function(t,e,i,s){if(Array.isArray(e))return this.setTimerM(t,e);var n;s||(s={});if(n=s.from?s.from:this[t],isNaN(n)&&(n.match(/^([0-9\-\.]+)(.*)$/)?(n=parseFloat(RegExp.$1),s.sfx=RegExp.$2):n=0),n==e)return this;var r=0;s.delay&&(r=s.delay);var a=(new Date).getTime(),o={from:n,to:e,st:a+r,et:a+r+i,opt:s};return this._tobjs[t]={tl:[o],tc:0},this},WBind.obj.prototype.setTimerM=function(t,e){for(var i=[],s=(new Date).getTime(),n=this[t],r=0;r<e.length;r++){var a=e[r].to,o=e[r].time,h=e[r].opt;h||(h={});isNaN(n)&&(n.match(/^([0-9\-\.]+)(.*)$/)?(n=parseFloat(RegExp.$1),h.sfx=RegExp.$2):n=0);var u=0;h.delay&&(u=h.delay),i.push({from:n,to:a,st:s+u,et:s+u+o,opt:h}),n=a}return this._tobjs[t]={tl:i,tc:0},console.log(i),this},WBind.obj.prototype.clearTimer=function(t){delete this._tobjs[t]},WBind.obj.prototype.updateTimer=function(){var t=(new Date).getTime();for(var e in this._tobjs){var i=this._tobjs[e],s=i.tl[i.tc];if(void 0!==s&&!(s.st>t))if(s.et<=t){var n=s.to;s.opt.sfx&&(n+=s.opt.sfx),this[e]=n,i.tc++,this._tobjs[e].tl.length<i.tc&&delete this._tobjs[e],s.opt.efunc&&s.opt.efunc(s.to)}else{var r=(t-s.st)/(s.et-s.st);if(s.opt.tfunc)if("string"==typeof s.opt.tfunc)switch(s.opt.tfunc){case"ease-in":r*=r;break;case"ease-out":r*=2-r;break;case"ease-inout":r=r*r*(3-2*r)}else r=s.opt.tfunc(r);var n=s.from+(s.to-s.from)*r;s.opt.sfx&&(n+=s.opt.sfx),this[e]=n}}},WBind.log=function(t){console.log(t)},WBind.addev=function(t,e,i,s){var n=WBind._getobj(t,s);if(n){n instanceof NodeList||Array.isArray(n)||(n=[n]);for(var r=0;r<n.length;r++)n[r].addEventListener(e,function(t){i(t)||t.preventDefault()})}},WBind.set=function(t,e){e||(e=document),t instanceof Array||(t=[t]);for(var i=0;i<t.length;i++){var n,r=t[i];if(r.obj&&(n=WBind._getobj(r.obj,e)),r.id&&(n=e.getElementById(r.id)),r.sel&&(n=e.querySelectorAll(r.sel)),n){n instanceof NodeList||Array.isArray(n)||(n=[n]);for(var a=0;a<n.length;a++)if(void 0!=r.html&&(n[a].innerHTML=r.html),void 0!=r.value&&(n[a].value=r.value),void 0!=r.attr&&n[a].setAttribute(r.attr,r.value),void 0!=r.style)for(s in r.style)n[a].style[s]=r.style[s]}}},t.WBind=WBind}),t("skylark-pox/WWG",["./pox"],function(t){function e(){this.version="0.9.11",this.can=null,this.gl=null,this.vsize={float:1,vec2:2,vec3:3,vec4:4,mat2:4,mat3:9,mat4:16}}return e.prototype.init=function(t,e){let i;return this.can=t,!(!(i=t.getContext("experimental-webgl",e))&&!(i=t.getContext("webgl",e)))&&(!!window.Promise&&(this.gl=i,this.ext_vao=i.getExtension("OES_vertex_array_object"),this.ext_vao&&(this.vao_create=function(){return this.ext_vao.createVertexArrayOES()},this.vao_bind=function(t){this.ext_vao.bindVertexArrayOES(t)}),this.ext_inst=i.getExtension("ANGLE_instanced_arrays"),this.ext_inst&&(this.inst_divisor=function(t,e){this.ext_inst.vertexAttribDivisorANGLE(t,e)},this.inst_draw=function(t,e,i,s,n){this.ext_inst.drawElementsInstancedANGLE(t,e,i,s,n)},this.inst_drawa=function(t,e,i,s){this.ext_inst.drawArrayInstancedANGLE(t,e,i,s)}),this.ext_anis=i.getExtension("EXT_texture_filter_anisotropic"),this.ext_ftex=i.getExtension("OES_texture_float"),this.ext_mrt=i.getExtension("WEBGL_draw_buffers"),this.ext_mrt&&(this.mrt_att=this.ext_mrt.COLOR_ATTACHMENT0_WEBGL,this.mrt_draw=function(t,e){return this.ext_mrt.drawBuffersWEBGL(t,e)}),this.ext_i32=i.getExtension("OES_element_index_uint"),this.ext_mv=i.getExtension("WEBGL_multiview"),this.ext_mv?console.log("MULTIVIEW extension is supported"):(this.ext_mv=i.getExtension("OVR_multiview"),this.ext_mv&&console.log("OVR MULTIVIEW extension is supported")),this.dmodes={tri_strip:i.TRIANGLE_STRIP,tri:i.TRIANGLES,points:i.POINTS,lines:i.LINES,line_strip:i.LINE_STRIP},this.version=1,!0))},e.prototype.init2=function(t,e){let i;return this.can=t,!(!(i=t.getContext("experimental-webgl2",e))&&!(i=t.getContext("webgl2",e)))&&(!!window.Promise&&(console.log("init for webGL2"),this.gl=i,this.ext_vao=!0,this.vao_create=function(){return this.gl.createVertexArray()},this.vao_bind=function(t){this.gl.bindVertexArray(t)},this.ext_inst=!0,this.inst_divisor=function(t,e){this.gl.vertexAttribDivisor(t,e)},this.inst_draw=function(t,e,i,s,n){this.gl.drawElementsInstanced(t,e,i,s,n)},this.inst_drawa=function(t,e,i,s){this.gl.drawArraysInstanced(t,e,i,s)},this.ext_anis=i.getExtension("EXT_texture_filter_anisotropic"),this.ext_anis&&(this.ext_anis_max=i.getParameter(this.ext_anis.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.ext_ftex=!0,this.ext_mrt=i.getParameter(i.MAX_DRAW_BUFFERS)>1,this.ext_mrt&&(this.mrt_att=i.COLOR_ATTACHMENT0,this.mrt_draw=function(t,e){return i.drawBuffers(t,e)}),this.ext_i32=!0,this.ext_mv=i.getExtension("WEBGL_multiview"),this.ext_mv?console.log("MULTIVIEW extension is supported"):(this.ext_mv=i.getExtension("OVR_multiview"),this.ext_mv&&console.log("OVR MULTIVIEW extension is supported")),this.dmodes={tri_strip:i.TRIANGLE_STRIP,tri:i.TRIANGLES,points:i.POINTS,lines:i.LINES,line_strip:i.LINE_STRIP},this.version=2,!0))},e.prototype.loadAjax=function(t,e){return new Promise((i,s)=>{const n=new XMLHttpRequest;n.open("get",t,!0),n.responseType=e&&e.type?e.type:"text",n.onload=(()=>{200==n.status?i(n.response):s("Ajax error:"+n.statusText)}),n.onerror=(()=>{s("Ajax error:"+n.statusText)}),n.send()})},e.prototype.loadImageAjax=function(t){return new Promise((e,i)=>{this.loadAjax(t,{type:"blob"}).then(t=>{const i=new Image,s=URL.createObjectURL(t);i.onload=(()=>{URL.revokeObjectURL(s),e(i)}),i.src=s}).catch(t=>{console.log(t),e(null)})})},e.prototype.createRender=function(){return new this.Render(this)},e.prototype.Render=function(t){this.wwg=t,this.gl=t.gl,this.env={},this.modelCount=0},e.prototype.Render.prototype.setUnivec=function(t,e){if(null==t.pos)return;let s=[];if(t.dim>0&&!(e instanceof Float32Array))for(let i=0;i<t.dim;i++)s=s.concat(e[i]);else s=e;if(null!=t.cache)if(Array.isArray(s)){for(let e=0;e<s.length&&s[e]==t.cache[e];e++);if(i==s.length)return}else if(s==t.cache)return;switch(t.type){case"mat2":this.gl.uniformMatrix2fv(t.pos,!1,this.f32Array(e));break;case"mat3":this.gl.uniformMatrix3fv(t.pos,!1,this.f32Array(e));break;case"mat4":this.gl.uniformMatrix4fv(t.pos,!1,this.f32Array(e));break;case"vec2":this.gl.uniform2fv(t.pos,this.f32Array(e));break;case"vec2v":this.gl.uniform2fv(t.pos,this.f32Array(s));break;case"vec3":this.gl.uniform3fv(t.pos,this.f32Array(e));break;case"vec3v":this.gl.uniform3fv(t.pos,this.f32Array(s));break;case"vec4":this.gl.uniform4fv(t.pos,this.f32Array(e));break;case"vec4v":this.gl.uniform4fv(t.pos,this.f32Array(s));break;case"int":case"bool":this.gl.uniform1i(t.pos,e);break;case"ivec2":case"bvec2":this.gl.uniform2iv(t.pos,this.i16Array(e));break;case"ivec2v":case"bvec2v":this.gl.uniform2iv(t.pos,this.i16Array(s));break;case"ivec3":case"bvec3":this.gl.uniform3iv(t.pos,this.i16Array(e));break;case"ivec3v":case"bvec3v":this.gl.uniform3iv(t.pos,this.i16Array(s));break;case"ivec4":case"bvec4":this.gl.uniform4iv(t.pos,this.i16Array(e));break;case"ivec4v":case"bvec4v":this.gl.uniform4iv(t.pos,this.i16Array(s));break;case"intv":case"boolv":this.gl.uniform1iv(t.pos,this.i16Array(e));break;case"float":this.gl.uniform1f(t.pos,e);break;case"floatv":this.gl.uniform1fv(t.pos,this.f32Array(e));break;case"sampler2D":if("string"==typeof e&&(e=this.getTexIndex(e)),this.gl.activeTexture(this.gl.TEXTURE0+t.texunit),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texobj[e]),void 0==this.data.texture[e])break;this.data.texture&&this.data.texture[e].video&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.data.texture[e].video),this.gl.uniform1i(t.pos,t.texunit)}},e.prototype.Render.prototype.setShader=function(t){let e=0;function s(t){const s=t.split("\n"),n=[],r=[],a={};for(i=0;i<s.length;i++){let t=s[i];if(t.match(/^\s*#define\s*([^\s]+)\s+([^\s]+)/)&&(a[RegExp.$1.trim()]=RegExp.$2.trim()),t.match(/^\s*uniform\s*([0-9a-z]+)\s+([0-9a-z_]+)(\[[^\]]+\])?/i)){let t={type:RegExp.$1,name:RegExp.$2};if(""!=RegExp.$3){t.type=t.type+"v";let e=RegExp.$3.substr(1,RegExp.$3.length-2).trim();t.dim=parseInt(e),isNaN(t.dim)&&(t.dim=a[e])}"sampler2D"==t.type&&(t.texunit=e++),n.push(t)}t.match(/^\s*(?:attribute|in)\s+([0-9a-z]+)\s*([0-9a-z_]+)/i)&&r.push({type:RegExp.$1,name:RegExp.$2})}return{uni:n,att:r}}const n=this.gl;return new Promise((e,i)=>{if(!t.vshader)return i("no vshader"),!1;if(!t.fshader)return i("no fshader"),!1;let r,a,o=[];t.vshader.text?r=t.vshader.text:t.vshader.src&&o.push(this.wwg.loadAjax(t.vshader.src).then(t=>{r=t,e()}).catch(t=>{i(t)})),t.fshader.text?a=t.fshader.text:t.fshader.src&&o.push(this.wwg.loadAjax(t.fshader.src).then(t=>{a=t,e()}).catch(t=>{i(t)})),Promise.all(o).then(t=>{let o={},h=n.createShader(n.VERTEX_SHADER);if(n.shaderSource(h,r),n.compileShader(h),!n.getShaderParameter(h,n.COMPILE_STATUS))return i("vs error:"+n.getShaderInfoLog(h)),!1;o.vshader=h;let u=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(u,a),n.compileShader(u),!n.getShaderParameter(u,n.COMPILE_STATUS))return i("fs error:"+n.getShaderInfoLog(u)),!1;o.fshader=u;let c=n.createProgram();if(n.attachShader(c,h),n.attachShader(c,u),n.linkProgram(c),!n.getProgramParameter(c,n.LINK_STATUS))return i("link error:"+n.getProgramInfoLog(c)),!1;o.program=c,n.useProgram(c);let l=s(r);o.vs_att={};for(let t in l.att)l.att[t].pos=n.getAttribLocation(c,l.att[t].name),o.vs_att[l.att[t].name]=l.att[t];o.vs_uni={};for(let t in l.uni)l.uni[t].pos=n.getUniformLocation(c,l.uni[t].name),l.uni[t].cache=null,o.vs_uni[l.uni[t].name]=l.uni[t];let f=s(a);o.fs_uni={};for(let t in f.uni)f.uni[t].pos=n.getUniformLocation(c,f.uni[t].name),f.uni[t].cache=null,o.fs_uni[f.uni[t].name]=f.uni[t];e(o)}).catch(t=>{i(t)})})},e.prototype.Render.prototype.setUniValues=function(t){if(t.vs_uni)for(let e in t.vs_uni)this.vs_uni[e]&&this.setUnivec(this.vs_uni[e],t.vs_uni[e]);if(t.fs_uni)for(let e in t.fs_uni)this.fs_uni[e]&&this.setUnivec(this.fs_uni[e],t.fs_uni[e]);return!0},e.prototype.Render.prototype.genTex=function(t,e){e||(e={flevel:0});let i=this.gl;const s={rgb:i.RGB,gray:i.LUMINANCE,grayalpha:i.LUMINANCE_ALPHA};let n=e.format&&s[e.format]?s[e.format]:i.RGBA,r=i.createTexture();switch(i.bindTexture(i.TEXTURE_2D,r),e.isarray?(t instanceof Float32Array?i.texImage2D(i.TEXTURE_2D,0,i.RGBA32F,e.width,e.height,0,n,i.FLOAT,t,0):i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e.width,e.height,0,n,i.UNSIGNED_BYTE,t),e.flevel=0,e.nomipmap=!0):i.texImage2D(i.TEXTURE_2D,0,n,n,i.UNSIGNED_BYTE,t),e.nomipmap||i.generateMipmap(i.TEXTURE_2D),e.flevel){case 0:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);break;case 1:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);break;case 2:i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)}return 2==e.repeat?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)):1==e.repeat?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.MIRRORED_REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.MIRRORED_REPEAT)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT)),this.wwg.ext_anis&&e.anisotropy&&i.texParameteri(i.TEXTURE_2D,this.wwg.ext_anis.TEXTURE_MAX_ANISOTROPY_EXT,e.anisotropy),i.bindTexture(i.TEXTURE_2D,null),r},e.prototype.Render.prototype.loadTex=function(t){this.gl;return new Promise((e,i)=>{if(t.src)if(t.opt&&t.opt.cors)this.wwg.loadImageAjax(t.src).then(i=>{e(this.genTex(i,t.opt))}).catch(t=>i(t));else{let s=new Image;s.onload=(()=>{e(this.genTex(s,t.opt))}),s.onerror=(()=>{i("cannot load image")}),s.src=t.src}else t.img instanceof Image?e(this.genTex(t.img,t.opt)):t.video?e(this.genTex(t.video,{nomipmap:!0,flevel:0,repeat:2})):t.buffer?void 0!=t.mrt?e(t.buffer.fb.t[t.mrt]):e(t.buffer.fb.t):t.texture?e(t.texture):t.canvas?e(this.genTex(t.canvas,t.opt)):t.array?(t.opt.isarray=!0,e(this.genTex(t.array,t.opt))):i("no image")})},e.prototype.Render.prototype.getTexIndex=function(t){if(!this.data.texture)return null;let e;for(e=0;e<this.data.texture.length&&this.data.texture[e].name!=t;e++);return e==this.data.texture.length?null:e},e.prototype.Render.prototype.addTex=function(t){return new Promise((e,i)=>{this.data.texture||(this.data.texture=[]),this.data.texture.push(t),this.loadTex(t).then(t=>{this.texobj.push(t),e(this.texobj.length-1)}).catch(t=>i(t))})},e.prototype.Render.prototype.removeTex=function(t){"string"==typeof t&&(t=this.getTexIndex(t)),null!==t&&(this.data.texture[t]=null,this.texobj[t]=null)},e.prototype.Render.prototype.frameBuffer=function(t){let e=this.gl;console.log("create framebuffer "+t.width+"x"+t.height);let i=t.mrt,s=e.UNSIGNED_BYTE,n=e.LINEAR;this.wwg.ext_ftex&&t.float&&(s=e.FLOAT,n=e.NEAREST,console.log("use float tex"));let r=[],a=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,a);let o=e.createRenderbuffer();if(e.bindRenderbuffer(e.RENDERBUFFER,o),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,o),i){let a=[];for(let o=0;o<i;o++)a[o]=e.createTexture(),e.bindTexture(e.TEXTURE_2D,a[o]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,s,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n),e.framebufferTexture2D(e.FRAMEBUFFER,this.wwg.mrt_att+o,e.TEXTURE_2D,a[o],0),r.push(this.wwg.mrt_att+o)}else{let i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,s,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null);let h={ox:t.offsetX,oy:t.offsetY,width:t.width,height:t.height,f:a,d:o,t:fTexture};return i&&(h.fblist=r),h},e.prototype.Render.prototype.setRender=function(t){let e=this.gl;return this.env=t.env,this.data=t,new Promise((i,s)=>{if(!e)return void s("no init");let n=[];this.setShader({fshader:t.fshader,vshader:t.vshader}).then(r=>{if(this.vshader=r.vshader,this.fshader=r.fshader,this.program=r.program,this.vs_uni=r.vs_uni,this.vs_att=r.vs_att,this.fs_uni=r.fs_uni,t.texture)for(let e=0;e<t.texture.length;e++)n.push(this.loadTex(t.texture[e]));Promise.all(n).then(n=>{if(this.texobj=n,this.setUniValues(t)){this.env.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this.env.face_cw?e.frontFace(e.CW):e.frontFace(e.CCW),this.env.nodepth?e.disable(e.DEPTH_TEST):e.enable(e.DEPTH_TEST);for(let e=0;e<t.model.length;e++)t.model[e].obuf=this.setObj(t.model[e],!0);this.modelCount=t.model.length,this.env.offscreen&&(this.env.offscreen.mrt&&(this.wwg.ext_mrt||s("MRT not support")),this.fb=this.frameBuffer(this.env.offscreen)),i(this)}else s("no uniform name")}).catch(t=>{s(t)})}).catch(t=>{s(t)})})},e.prototype.Render.prototype.clear=function(){let t=this.env.clear_color;this.gl.clearColor(t[0],t[1],t[2],t[3]),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},e.prototype.Render.prototype.f32Array=function(t){return t instanceof Float32Array?t:new Float32Array(t)},e.prototype.Render.prototype.i16Array=function(t){return t instanceof Int16Array?t:new Int16Array(t)},e.prototype.Render.prototype.i32Array=function(t){return t instanceof Uint32Array?t:new Uint32Array(t)},e.prototype.Render.prototype.setObj=function(t,e){let i,s=this.gl,n=t.geo,r=t.inst;ret={},this.wwg.ext_vao&&(i=this.wwg.vao_create(),this.wwg.vao_bind(i),ret.vao=i);let a=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,a);let o=0,h=[];for(let t=0;t<n.vtx_at.length;t++)h.push(this.vs_att[n.vtx_at[t]]),o+=this.wwg.vsize[this.vs_att[n.vtx_at[t]].type];ret.ats=h,ret.tl=o;let u,c,l=0;for(let t in this.vs_att)this.vs_att[t].pos>=0&&s.disableVertexAttribArray(this.vs_att[t].pos);for(let t=0;t<h.length;t++){let e=this.wwg.vsize[h[t].type];s.enableVertexAttribArray(this.vs_att[h[t].name].pos),s.vertexAttribPointer(this.vs_att[h[t].name].pos,e,s.FLOAT,!1,4*o,l),l+=4*e}if(ret.vbo=a,n.idx&&(u=s.createBuffer(),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,u),ret.ibo=u),r){c=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,c);let t=0,e=[];for(let i=0;i<r.attr.length;i++)e.push(this.vs_att[r.attr[i]]),t+=this.wwg.vsize[this.vs_att[r.attr[i]].type];t*=4,ret.iats=e,ret.itl=t;let i=0;for(let n=0;n<e.length;n++){let a=r.divisor?r.divisor[n]:1,o=this.wwg.vsize[e[n].type],h=this.vs_att[e[n].name].pos;s.enableVertexAttribArray(h),s.vertexAttribPointer(h,o,s.FLOAT,!1,t,i),i+=4*o,this.wwg.inst_divisor(h,a)}ret.inst=c}return this.wwg.ext_vao&&this.wwg.vao_bind(null),this.wwg.ext_vao&&this.wwg.vao_bind(i),e&&(s.bindBuffer(s.ARRAY_BUFFER,a),s.bufferData(s.ARRAY_BUFFER,this.f32Array(n.vtx),n.dynamic?s.DYNAMIC_DRAW:s.STATIC_DRAW)),e&&n.idx&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,u),n.vtx.length/ret.tl>65536&&this.wwg.ext_i32?(s.bufferData(s.ELEMENT_ARRAY_BUFFER,this.i32Array(n.idx),s.STATIC_DRAW),ret.i32=!0):(s.bufferData(s.ELEMENT_ARRAY_BUFFER,this.i16Array(n.idx),s.STATIC_DRAW),ret.i32=!1)),e&&r&&(s.bindBuffer(s.ARRAY_BUFFER,c),s.bufferData(s.ARRAY_BUFFER,this.f32Array(r.data),r.dynamic?s.DYNAMIC_DRAW:s.STATIC_DRAW)),this.wwg.ext_vao&&this.wwg.vao_bind(null),ret},e.prototype.Render.prototype.getModels=function(){return this.data.model.filter(t=>null!==t)},e.prototype.Render.prototype.getModelIdx=function(t){let e=!1;if("string"!=typeof t)e=parseInt(t);else for(let i=0;i<this.data.model.length;i++)if(null!==this.data.model[i]&&t==this.data.model[i].name){e=i;break}return e},e.prototype.Render.prototype.addModel=function(t){let e=!1;if(t.name&&(e=this.getModelIdx(t.name)),!1!==e)return this.data.model[e]=t,void(this.data.model[e].obuf=this.setObj(t,!0));this.data.model.push(t),this.data.model[this.data.model.length-1].obuf=this.setObj(t,!0),this.modelCount++},e.prototype.Render.prototype.removeModel=function(t){let e=this.getModelIdx(t);return!1!==e&&(this.data.model[e].obuf=null,this.data.model[e]=null,this.modelCount--,!0)},e.prototype.Render.prototype.updateModel=function(t,e,i,s=!0){let n=this.getModelIdx(t),r=this.data.model[n].obuf;switch(e){case"vbo":this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vbo);break;case"inst":this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.inst)}s?this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.f32Array(i)):this.gl.bufferData(this.gl.ARRAY_BUFFER,this.f32Array(i),this.gl.DYNAMIC_DRAW)},e.prototype.Render.prototype.updateModelInstance=function(t,e,i){let s=this.getModelIdx(t),n=this.data.model[s].obuf;this.data.model[s].inst.count=i,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n.inst),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.f32Array(e),this.gl.DYNAMIC_DRAW)},e.prototype.Render.prototype.getModelData=function(t){let e=this.getModelIdx(t);return this.data.model[e]},e.prototype.Render.prototype.updateTex=function(t,e,i){"string"==typeof t&&(t=this.getTexIndex(t));var s=this.data.texture[t];this.gl.bindTexture(this.gl.TEXTURE_2D,this.texobj[t]),s.array?i?s.array instanceof Float32Array?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.width,i.height,this.gl.RGBA,this.gl.FLOAT,e,i.ofs):this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.width,i.height,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e,i.ofs):s.array instanceof Float32Array?this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA16F,s.opt.width,s.opt.height,0,this.gl.RGBA,this.gl.FLOAT,e):this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,s.opt.width,s.opt.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):i?i.wx>0&&i.wy>0?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,i.wx,i.wy,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,i.sx,i.sy,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e):this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),s.opt&&!s.opt.nomipmap&&this.gl.generateMipmap(this.gl.TEXTURE_2D)},e.prototype.Render.prototype.pushUniValues=function(t){if(t.vs_uni)for(let e in t.vs_uni)this.update_uni.vs_uni[e]=t.vs_uni[e];if(t.fs_uni)for(let e in t.fs_uni)this.update_uni.fs_uni[e]=t.fs_uni[e]},e.prototype.Render.prototype.updateUniValues=function(t){t?this.setUniValues(this.update_uni):this.update_uni={vs_uni:{},fs_uni:{}}},e.prototype.Render.prototype.draw=function(t,e){let i=this.gl;i.useProgram(this.program),this.env.offscreen&&(i.bindFramebuffer(i.FRAMEBUFFER,this.fb.f),this.env.offscreen.mrt&&this.wwg.mrt_draw(this.fb.fblist),i.viewport(fb.offsetX,fb.offsetY,this.fb.width,this.fb.height)),e||this.clear();let s=this.data.model;for(let e=0;e<s.length;e++){if(null===s[e])continue;let n=s[e];if(n.hide)continue;if(null==n.obuf)continue;let r=n.geo;if(this.updateUniValues(0),this.pushUniValues(this.data),this.pushUniValues(n),t){Array.isArray(t)||(t=[t]);for(let i=0;i<t.length;i++)if(this.pushUniValues(t[i]),t[i].model){let s=t[i].model[e];s&&this.pushUniValues(s)}}this.updateUniValues(1);let a=n.obuf,o=r.ofs>0?r.ofs:0;if(this.wwg.ext_vao)this.wwg.vao_bind(a.vao);else{i.bindBuffer(i.ARRAY_BUFFER,a.vbo);let t=0;for(let t in this.vs_att)i.disableVertexAttribArray(this.vs_att[t].pos);for(let e=0;e<a.ats.length;e++){let s=this.wwg.vsize[a.ats[e].type];i.enableVertexAttribArray(this.vs_att[a.ats[e].name].pos),i.vertexAttribPointer(this.vs_att[a.ats[e].name].pos,s,i.FLOAT,!1,4*a.tl,t),t+=4*s}if(a.ibo&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a.ibo),a.inst){let t=n.inst;i.bindBuffer(i.ARRAY_BUFFER,a.inst);let e=0;for(let s=0;s<a.iats.length;s++){let n=t.divisor?t.divisor[s]:1,r=this.wwg.vsize[a.iats[s].type],o=this.vs_att[a.iats[s].name].pos;i.enableVertexAttribArray(o),i.vertexAttribPointer(o,r,i.FLOAT,!1,a.itl,e),e+=4*r,this.wwg.inst_divisor(o,n)}}}n.preFunction&&n.preFunction(i,n,a),void 0!==n.blend&&(i.enable(i.BLEND),"alpha"==n.blend&&i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE)),void 0!==n.cull&&(n.cull?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE));let h=this.wwg.dmodes[r.mode];if(void 0==h)return console.log("Error: illigal draw mode"),!1;n.inst?r.idx?this.wwg.inst_draw(h,r.idx.length,a.i32?i.UNSIGNED_INT:i.UNSIGNED_SHORT,o,n.inst.count):this.wwg.inst_drawa(h,o,r.count>0?r.count:r.vtx.length/a.tl,n.inst.count):r.idx?i.drawElements(h,r.idx.length,a.i32?i.UNSIGNED_INT:i.UNSIGNED_SHORT,o):i.drawArrays(h,o,r.count>0?r.count:r.vtx.length/a.tl),this.wwg.ext_vao&&this.wwg.vao_bind(null),void 0!==n.blend&&i.disable(i.BLEND),void 0!==n.cull&&(this.env.cull?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE)),n.postFunction&&n.postFunction(i,n)}return this.env.offscreen&&(i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.wwg.can.width,this.wwg.can.height)),!0},t.WWG=e}),t("skylark-pox/WWModel",["./pox","./CanvasMatrix4"],function(t,e){class i{primitive(t,i){i||(i={});let s=i.wx?i.wx:1,n=i.wy?i.wy:1,r=i.wz?i.wz:1,a=i.div?i.div:10,o=i.divx?i.divx:a,h=i.divy?i.divy:a,u=i.divz?i.divz:a,c=i.ninv?-1:1,l=[],f=[],p=[],m=[],d=2*Math.PI,b={r05:{v:[[-.52573111,-.7236068,.4472136],[-.85065081,.2763932,.4472136],[-0,.89442719,.4472136],[.85065081,.2763932,.4472136],[.52573111,-.7236068,.4472136],[0,-.89442719,-.4472136],[-.85065081,-.2763932,-.4472136],[-.52573111,.7236068,-.4472136],[.52573111,.7236068,-.4472136],[.85065081,-.2763932,-.4472136],[0,0,1],[-0,0,-1]],s:[[0,1,6],[0,6,5],[0,5,4],[0,4,10],[0,10,1],[1,2,7],[1,7,6],[1,10,2],[2,3,8],[2,8,7],[2,10,3],[3,4,9],[3,9,8],[3,10,4],[4,5,9],[5,6,11],[5,11,9],[6,7,11],[7,8,11],[8,9,11]]},r04:{v:[[-.35682209,-.49112347,.79465447],[.35682209,-.49112347,.79465447],[.57735027,-.79465447,.18759247],[0,-.98224695,-.18759247],[-.57735027,-.79465447,.18759247],[-.57735027,.18759247,.79465447],[.57735027,.18759247,.79465447],[.93417236,-.303531,-.18759247],[-0,-.607062,-.79465447],[-.93417236,-.303531,-.18759247],[-.93417236,.303531,.18759247],[0,.607062,.79465447],[.93417236,.303531,.18759247],[.57735027,-.18759247,-.79465447],[-.57735027,-.18759247,-.79465447],[-.57735027,.79465447,-.18759247],[0,.98224695,.18759247],[.57735027,.79465447,-.18759247],[.35682209,.49112347,-.79465447],[-.35682209,.49112347,-.79465447]],s:[[0,1,6,11,5],[0,5,10,9,4],[0,4,3,2,1],[1,2,7,12,6],[2,3,8,13,7],[3,4,9,14,8],[5,11,16,15,10],[6,12,17,16,11],[7,13,18,17,12],[8,14,19,18,13],[9,10,15,19,14],[15,16,17,18,19]]},r03:{v:[[-.57735027,-.57735027,.57735027],[-.57735027,.57735027,.57735027],[.57735027,.57735027,.57735027],[.57735027,-.57735027,.57735027],[-.57735027,-.57735027,-.57735027],[-.57735027,.57735027,-.57735027],[.57735027,.57735027,-.57735027],[.57735027,-.57735027,-.57735027]],s:[[0,1,5,4],[0,4,7,3],[0,3,2,1],[1,2,6,5],[2,3,7,6],[4,5,6,7]]},r02:{v:[[-.70710678,-.70710678,0],[-.70710678,.70710678,0],[.70710678,.70710678,0],[.70710678,-.70710678,0],[0,0,-1],[0,0,1]],s:[[0,1,4],[0,4,3],[0,3,5],[0,5,1],[1,2,4],[1,5,2],[2,3,4],[2,5,3]]},r01:{v:[[-.81649658,-.47140452,.33333333],[.81649658,-.47140452,.33333333],[0,0,-1],[0,.94280904,.33333333]],s:[[0,1,3],[0,3,2],[0,2,1],[1,2,3]]},s11:{v:[[-.13149606,-.40470333,.90494412],[-.34426119,-.25012042,.90494412],[-.42553024,-1e-8,.90494412],[-.34426119,.2501204,.90494412],[-.13149606,.40470332,.90494412],[.13149611,.40470332,.90494412],[.34426124,.2501204,.90494412],[.42553028,-1e-8,.90494412],[.34426124,-.25012042,.90494412],[.13149611,-.40470333,.90494412],[-.13149606,-.62841783,.76668096],[-.34426119,-.69754941,.6284178],[-.42553024,-.80940666,.4047033],[-.34426119,-.92126391,.18098881],[-.13149606,-.99039549,.04272564],[.13149611,-.99039549,.04272564],[.34426124,-.92126391,.18098881],[.42553028,-.80940666,.4047033],[.34426124,-.69754941,.6284178],[.13149611,-.62841783,.76668096],[-.55702632,-.5429665,.6284178],[-.55702632,-.319252,.76668096],[-.63829537,-.06913159,.76668096],[-.76979145,.11185724,.6284178],[-.90128753,.15458291,.4047033],[-.98255658,.04272566,.1809888],[-.98255658,-.18098884,.04272564],[-.90128753,-.43110925,.04272564],[-.76979145,-.61209808,.18098881],[-.63829537,-.65482375,.4047033],[-.82001848,.54296648,.18098881],[-.82001848,.40470332,.4047033],[-.6885224,.36197765,.6284178],[-.47575727,.43110923,.76668096],[-.26299214,.58569215,.76668096],[-.13149606,.76668098,.6284178],[-.13149606,.90494414,.4047033],[-.26299214,.94766981,.18098881],[-.47575727,.87853823,.04272564],[-.6885224,.72395531,.04272564],[.47575732,.87853821,.04272564],[.26299219,.94766979,.1809888],[.13149611,.90494413,.4047033],[.13149611,.76668098,.6284178],[.26299219,.58569215,.76668096],[.47575732,.43110923,.76668096],[.68852245,.36197765,.6284178],[.82001853,.4047033,.40470331],[.82001853,.54296646,.18098881],[.68852245,.72395529,.04272564],[.63829541,-.65482375,.4047033],[.7697915,-.61209808,.18098881],[.90128758,-.43110925,.04272564],[.98255663,-.18098884,.04272564],[.98255647,.04272561,.18098879],[.9012875,.15458288,.40470331],[.7697915,.11185724,.6284178],[.63829541,-.06913159,.76668096],[.55702637,-.319252,.76668096],[.55702637,-.5429665,.6284178],[-.47575727,-.87853824,-.04272569],[-.6885224,-.72395533,-.04272569],[-.82001848,-.5429665,-.18098886],[-.82001848,-.40470333,-.40470335],[-.6885224,-.36197767,-.62841785],[-.47575727,-.43110925,-.76668101],[-.26299214,-.58569216,-.76668101],[-.13149605,-.76668099,-.62841784],[-.13149606,-.90494416,-.40470335],[-.26299214,-.94766982,-.18098885],[-.90128753,-.15458292,-.40470335],[-.98255658,-.04272567,-.18098885],[-.98255658,.18098882,-.04272569],[-.90128753,.43110923,-.04272569],[-.76979145,.61209806,-.18098885],[-.63829536,.65482373,-.40470335],[-.55702632,.54296648,-.62841785],[-.55702632,.31925199,-.76668101],[-.63829537,.06913157,-.76668101],[-.76979145,-.11185726,-.62841785],[-.13149606,.62841781,-.76668101],[-.34426119,.6975494,-.62841785],[-.42553023,.80940665,-.40470335],[-.34426119,.92126389,-.18098885],[-.13149606,.99039547,-.04272569],[.13149611,.99039546,-.04272569],[.34426124,.92126387,-.18098886],[.42553028,.80940661,-.40470335],[.34426124,.69754939,-.62841785],[.13149611,.62841781,-.76668101],[.76979153,-.11185725,-.62841782],[.63829541,.06913155,-.76668097],[.55702634,.31925197,-.76668097],[.55702635,.54296649,-.62841782],[.63829541,.6548237,-.40470335],[.76979149,.61209803,-.18098885],[.9012875,.43110919,-.04272571],[.98255648,.18098877,-.04272572],[.9825564,-.04272561,-.18098874],[.90128711,-.15458281,-.4047032],[.26299219,-.94766982,-.18098885],[.13149611,-.90494416,-.40470335],[.13149611,-.76668098,-.62841784],[.26299219,-.58569215,-.76668099],[.47575682,-.43110886,-.76668009],[.68852237,-.36197738,-.6284173],[.82001805,-.40470325,-.40470322],[.82001853,-.5429665,-.18098885],[.68852245,-.72395533,-.04272569],[.47575732,-.87853824,-.04272569],[-.13149606,-.40470333,-.90494417],[-.34426119,-.25012042,-.90494417],[-.42553024,-0,-.90494417],[-.34426119,.2501204,-.90494417],[-.13149606,.40470332,-.90494417],[.13149611,.40470332,-.90494417],[.3442612,.25012038,-.90494414],[.42553027,-3e-8,-.90494414],[.3442606,-.25012001,-.90494332],[.13149611,-.40470332,-.90494416]],s:[[0,1,21,20,11,10],[0,10,19,9],[0,9,8,7,6,5,4,3,2,1],[1,2,22,21],[2,3,33,32,23,22],[3,4,34,33],[4,5,44,43,35,34],[5,6,45,44],[6,7,57,56,46,45],[7,8,58,57],[8,9,19,18,59,58],[10,11,12,13,14,15,16,17,18,19],[11,20,29,12],[12,29,28,61,60,13],[13,60,69,14],[14,69,68,101,100,15],[15,100,109,16],[16,109,108,51,50,17],[17,50,59,18],[20,21,22,23,24,25,26,27,28,29],[23,32,31,24],[24,31,30,73,72,25],[25,72,71,26],[26,71,70,63,62,27],[27,62,61,28],[30,31,32,33,34,35,36,37,38,39],[30,39,74,73],[35,43,42,36],[36,42,41,85,84,37],[37,84,83,38],[38,83,82,75,74,39],[40,41,42,43,44,45,46,47,48,49],[40,49,95,94,87,86],[40,86,85,41],[46,56,55,47],[47,55,54,97,96,48],[48,96,95,49],[50,51,52,53,54,55,56,57,58,59],[51,108,107,52],[52,107,106,99,98,53],[53,98,97,54],[60,61,62,63,64,65,66,67,68,69],[63,70,79,64],[64,79,78,112,111,65],[65,111,110,66],[66,110,119,103,102,67],[67,102,101,68],[70,71,72,73,74,75,76,77,78,79],[75,82,81,76],[76,81,80,114,113,77],[77,113,112,78],[80,81,82,83,84,85,86,87,88,89],[80,89,115,114],[87,94,93,88],[88,93,92,116,115,89],[90,91,92,93,94,95,96,97,98,99],[90,99,106,105],[90,105,104,118,117,91],[91,117,116,92],[100,101,102,103,104,105,106,107,108,109],[103,119,118,104],[110,111,112,113,114,115,116,117,118,119]]},s06:{v:[[-.20177411,-.27771823,.93923362],[-.40354821,-.55543646,.72707577],[-.20177411,-.8331547,.51491792],[.20177411,-.8331547,.51491792],[.40354821,-.55543646,.72707577],[.20177411,-.27771823,.93923362],[-.32647736,.10607893,.93923362],[-.65295472,.21215785,.72707577],[-.85472883,-.06556038,.51491792],[-.73002557,-.44935754,.51491792],[-.73002557,-.66151539,.17163931],[-.40354821,-.89871508,.17163931],[-.20177411,-.96427546,-.17163931],[.20177411,-.96427546,-.17163931],[.40354821,-.89871508,.17163931],[.73002557,-.66151539,.17163931],[.73002557,-.44935754,.51491792],[.85472883,-.06556038,.51491792],[.65295472,.21215785,.72707577],[.32647736,.10607893,.93923362],[-0,.34327861,.93923362],[-.65295472,.55543646,.51491792],[-.85472883,.48987608,.17163931],[-.97943209,.10607893,.17163931],[-.97943209,-.10607892,-.17163931],[-.85472883,-.48987608,-.17163931],[-.65295472,-.55543646,-.51491792],[-.32647736,-.79263615,-.51491792],[-0,-.68655723,-.72707577],[.32647736,-.79263615,-.51491792],[.65295472,-.55543646,-.51491792],[.85472883,-.48987608,-.17163931],[.97943209,-.10607893,-.17163931],[.97943209,.10607893,.17163931],[.85472883,.48987608,.17163931],[.65295472,.55543646,.51491792],[.32647736,.79263615,.51491792],[0,.68655723,.72707577],[-.32647736,.79263615,.51491792],[-.73002557,.66151539,-.17163931],[-.73002557,.44935754,-.51491792],[-.85472883,.06556038,-.51491792],[-.65295472,-.21215785,-.72707577],[-.32647736,-.10607892,-.93923362],[0,-.34327861,-.93923362],[.32647736,-.10607892,-.93923362],[.65295472,-.21215785,-.72707577],[.85472883,.06556038,-.51491792],[.73002557,.44935754,-.51491792],[.73002557,.66151539,-.17163931],[.40354821,.89871508,-.17163931],[.20177411,.96427546,.17163931],[-.20177411,.96427546,.17163931],[-.40354821,.89871508,-.17163931],[-.20177411,.83315469,-.51491792],[-.40354821,.55543646,-.72707577],[-.20177411,.27771823,-.93923362],[.2017741,.27771823,-.93923362],[.40354821,.55543646,-.72707577],[.20177411,.83315469,-.51491792]],s:[[0,5,19,20,6],[0,6,7,8,9,1],[0,1,2,3,4,5],[1,9,10,11,2],[2,11,12,13,14,3],[3,14,15,16,4],[4,16,17,18,19,5],[6,20,37,38,21,7],[7,21,22,23,8],[8,23,24,25,10,9],[10,25,26,27,12,11],[12,27,28,29,13],[13,29,30,31,15,14],[15,31,32,33,17,16],[17,33,34,35,18],[18,35,36,37,20,19],[21,38,52,53,39,22],[22,39,40,41,24,23],[24,41,42,26,25],[26,42,43,44,28,27],[28,44,45,46,30,29],[30,46,47,32,31],[32,47,48,49,34,33],[34,49,50,51,36,35],[36,51,52,38,37],[39,53,54,55,40],[40,55,56,43,42,41],[43,56,57,45,44],[45,57,58,48,47,46],[48,58,59,50,49],[50,59,54,53,52,51],[54,59,58,57,56,55]]}};switch(t){case"sphere":for(let t=0;t<=a;++t){let e=t/(0+a),i=Math.cos(Math.PI*e),o=Math.sin(Math.PI*e);for(let t=0;t<=2*a;++t){let h=t/(0+2*a),u=Math.cos(d*h)*o,m=Math.sin(d*h)*o;l.push([u*s,i*n,m*r]),f.push([u*c,i*c,m*c]),p.push([c>0?1-h:h,1-e])}}let e=2*a+1;for(let t=0;t<a;++t){let i=t*e;for(let t=0;t<2*a;++t)c>0?m.push([i+t,i+t+1,i+t+e],[i+t+e,i+t+1,i+t+1+e]):m.push([i+t+e,i+t+1,i+t],[i+t+1+e,i+t+1,i+t+e])}break;case"sphere2":const x=i.div?i.div:6,y=Math.PI/2;for(let t=0;t<x;t++){let e=Math.sin(y*t/x),i=Math.cos(y*t/x),a=x-t;for(let o=0;o<=a;o++){let h=Math.cos(y*o/a)*i,u=Math.sin(y*o/a)*i;l.push([h*s,e*n,u*r]),f.push([h,e,u]),p.push([1-o/a/4,.5+t/x/2])}}l.push([0,n,0]),f.push([0,1,0]),p.push([.75,1]);let _=0;for(let t=0;t<x;t++){let e=2*(x-t)-1,i=x-t+1;for(let t=0;t<e;t++){let e=Math.floor(t/2);t%2==0?c>0?m.push([e+_,e+_+i,e+_+1]):m.push([e+_,e+_+1,e+_+i]):c>0?m.push([e+1+_,e+_+i,e+_+i+1]):m.push([e+1+_,e+_+i+1,e+_+i])}_+=i}let w=l.length,R=m.length;for(let t=0;t<w;t++)l.push([l[t][0],-l[t][1],l[t][2]]),f.push([l[t][0],-l[t][1],l[t][2]]),p.push([p[t][0],1-p[t][1]]);for(let t=0;t<R;t++)m.push([m[t][0]+w,m[t][2]+w,m[t][1]+w]);w=l.length,R=m.length;for(let t=0;t<w;t++)l.push([-l[t][0],l[t][1],l[t][2]]),f.push([-l[t][0],l[t][1],l[t][2]]),p.push([1-p[t][0]+.5,p[t][1]]);for(let t=0;t<R;t++)m.push([m[t][0]+w,m[t][2]+w,m[t][1]+w]);w=l.length,R=m.length;for(let t=0;t<w;t++)l.push([l[t][0],l[t][1],-l[t][2]]),f.push([l[t][0],l[t][1],-l[t][2]]),p.push([1-p[t][0],p[t][1]]);for(let t=0;t<R;t++)m.push([m[t][0]+w,m[t][2]+w,m[t][1]+w]);break;case"cylinder":h=i.divy?i.divy:1;for(let t=0;t<=a;++t){let e=t/(0+a),i=Math.sin(d*e)*r,o=Math.cos(d*e)*s,u=2*n/h;for(let t=0;t<=h;t++)l.push([o,t*u-n,i]),f.push([o*c,0,i*c]),p.push([c>0?1-e:e,t/h])}for(let t=0;t<a;t++)for(let e=0;e<h;e++){let i=t*(h+1)+e;c<0?m.push([i,i+(h+1),i+(h+1)+1,i+1]):m.push([i,i+1,i+3,i+2])}i.cap;break;case"ring":h=i.divy?i.divy:1;for(let t=0;t<=a;++t){let e=t/(0+a),i=Math.sin(d*e)*r,o=Math.cos(d*e)*s;for(let t=0;t<h;t++)l.push([o,n,i]),f.push([o*c,0,i*c]),p.push([c>0?1-e:e,1]),l.push([o,-n,i]),f.push([o*c,0,i*c,0]),p.push([c>0?1-e:e,0])}for(let t=0;t<a;t++)c>0?m.push([2*t,2*t+2,2*t+3,2*t+1]):m.push([2*t,2*t+1,2*t+3,2*t+2]);i.cap;break;case"cone":for(let t=0;t<=a;++t){let e=t/(0+a),i=Math.sin(d*e)*r,o=Math.cos(d*e)*s;l.push([0,n,0]),f.push([o*c,0,i*c]),p.push([c>0?1-e:e,1]),l.push([o,-n,i]),f.push([o*c,0,i*c,0]),p.push([c>0?1-e:e,0])}for(let t=0;t<a;t++)c>0?m.push([2*t,2*t+2,2*t+3,2*t+1]):m.push([2*t,2*t+1,2*t+3,2*t+2]);break;case"disc":for(let t=0;t<a;++t){let e=t/(0+a),i=Math.cos(d*e)*r,n=Math.sin(d*e)*s;l.push([n,0,i]),f.push([0,1,0]),p.push([(n/s+1)/2,(i/r+1)/2])}l.push([0,0,0]),f.push([0,1,0]),p.push([.5,.5]);for(let t=0;t<a-1;t++)m.push([t,t+1,a]);m.push([a-1,0,a]);break;case"plane":i.wz?i.wx?(l=[[s,0,r],[s,0,-r],[-s,0,-r],[-s,0,r]],f=[[0,c,0],[0,c,0],[0,c,0],[0,c,0]]):(l=[[0,-n,-r],[0,n,-r],[0,n,r],[0,-n,r]],f=[[c,0,0],[c,0,0],[c,0,0],[c,0,0]]):(l=[[s,-n,0],[s,n,0],[-s,n,0],[-s,-n,0]],f=[[0,0,c],[0,0,c],[0,0,c],[0,0,c]]),p=c>0?[[1,0],[1,1],[0,1],[0,0]]:[[-1,0],[-1,1],[0,1],[0,0]],m=c>0?[[0,1,2],[2,3,0]]:[[2,1,0],[0,3,2]];break;case"box":l=[[s,n,r],[s,-n,r],[-s,-n,r],[-s,n,r],[s,n,-r],[s,-n,-r],[-s,-n,-r],[-s,n,-r],[s,n,r],[s,-n,r],[s,-n,-r],[s,n,-r],[-s,n,r],[-s,-n,r],[-s,-n,-r],[-s,n,-r],[s,n,r],[s,n,-r],[-s,n,-r],[-s,n,r],[s,-n,r],[s,-n,-r],[-s,-n,-r],[-s,-n,r]],f=[[0,0,c],[0,0,c],[0,0,c],[0,0,c],[0,0,-c],[0,0,-c],[0,0,-c],[0,0,-c],[c,0,0],[c,0,0],[c,0,0],[c,0,0],[-c,0,0],[-c,0,0],[-c,0,0],[-c,0,0],[0,c,0],[0,c,0],[0,c,0],[0,c,0],[0,-c,0],[0,-c,0],[0,-c,0],[0,-c,0]],p=1==i.cubemap?[[.75,2/3],[.75,1/3],[1,1/3],[1,2/3],[.5,2/3],[.5,1/3],[.25,1/3],[.25,2/3],[.75,2/3],[.75,1/3],[.5,1/3],[.5,2/3],[0,2/3],[0,1/3],[.25,1/3],[.25,2/3],[.5,1],[.5,2/3],[.25,2/3],[.25,1],[.5,0],[.5,1/3],[.25,1/3],[.25,0]]:[[1,1],[1,0],[0,0],[0,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[1,1],[1,0],[0,0],[0,1],[1,0],[1,1],[0,1],[0,0],[1,1],[1,0],[0,0],[0,1]],m=c>0?[[3,1,0],[2,1,3],[4,5,7],[7,5,6],[8,9,11],[11,9,10],[15,13,12],[14,13,15],[16,17,19],[19,17,18],[23,21,20],[22,21,23]]:[[0,1,3],[3,1,2],[7,5,4],[6,5,7],[11,9,8],[10,9,11],[12,13,15],[15,13,14],[19,17,16],[18,17,19],[20,21,23],[23,21,22]];break;case"mesh":return this.parametricModel(function(t,e){let i={px:(t-.5)*s,py:0,pz:(e-.5)*r,nx:0,ny:1,nz:0,mu:t,mv:e};return i},{start:1,end:0,div:o},{start:0,end:1,div:u},{ninv:i.ninv}),this;case"torus":return this.parametricModel(function(t,e){let a=i.sr?i.sr:.5,o=t,h=-e,u=Math.sin(o*d),c=Math.cos(o*d),l=Math.sin(h*d),f=Math.cos(h*d),p=a*l*u,m=a*l*c,b=a*f,v=(Math.hypot(p,b,m),1*u+1*p),g=1*c+1*m,x=1*b,y={px:v*s,py:x*n,pz:g*r,nx:0,ny:0,nz:0,mu:t,mv:e};return y},{start:0,end:1,div:2*o},{start:0,end:1,div:h},{ninv:i.ninv}),this;case"polyhedron":if(!b[i.shape])return null;let E=b[i.shape].v,A=b[i.shape].s,T=0;for(let t=0;t<A.length;t++){let e=0,i=0,s=0,n=[];for(let r=A[t].length-1;r>=0;r--){let a=E[A[t][r]];l.push([a[0],a[2],a[1]]),e+=a[0],i+=a[2],s+=a[1],n.push(T),T++}let r=Math.hypot(e,i,s);for(let n=0;n<A[t].length;n++)f.push([e/r,i/r,s/r]);m.push(n)}p=null;break;case"icosa":E=b.r05.v,A=b.r05.s;for(let t=0;t<E.length;t++){let e=[E[t][0],E[t][2],E[t][1]];l.push(e),f.push(e),v(e)}for(let t=0;t<A.length;t++)c<0?m.push([A[t][0],A[t][1],A[t][2]]):m.push([A[t][0],A[t][2],A[t][1]]);const M=void 0!==i.div?i.div:2;for(let t=0;t<M;t++)g(l,m);for(let t=0;t<l.length;t++)l[t][0]*=s,l[t][1]*=n,l[t][2]*=r}function v(t){let e=Math.atan2(t[2],t[0])/Math.PI/2;p.push([(1-e)%1,1-Math.acos(t[1])/Math.PI])}function g(t,i){let s=t.length,n=i.length;for(let r=0;r<n;r++){let n=i[r][0],a=i[r][1],o=i[r][2],h=t[n],u=t[a],c=t[o],l=e.V3norm(e.V3add(h,u)),p=e.V3norm(e.V3add(u,c)),m=e.V3norm(e.V3add(c,h));t.push(l),t.push(p),t.push(m),f.push(l),f.push(p),f.push(m),v(l),v(p),v(m),i[r]=[n,s,s+2],i.push([s,s+1,s+2]),i.push([a,s+1,s]),i.push([o,s+2,s+1]),s+=3}}return this.obj_v=l,this.obj_n=f,this.obj_t=p,this.obj_i=m,this}parametricModel(t,e,i,s){let n=[],r=[],a=[],o=[],h=s&&s.ninv?-1:1,u=(e.end-e.start)/e.div,c=(i.end-i.start)/i.div;for(let s=0;s<=e.div;s++)for(let o=0;o<=i.div;o++){let l=e.start+u*s,f=i.start+c*o,p=t(l,f);if(n.push([p.px,p.py,p.pz]),void 0!=p.mu&&a.push([p.mu,p.mv]),0==p.nx&&0==p.ny&&0==p.nz){let e=u/10,i=c/10,s=t(l-e,f),n=t(l+e,f),r=(n.px-s.px)/(2*e),a=(n.py-s.py)/(2*e),o=(n.pz-s.pz)/(2*e),h=t(l,f-i),m=t(l,f+i),d=(m.px-h.px)/(2*i),b=(m.py-h.py)/(2*i),v=(m.pz-h.pz)/(2*i),g=a*v-o*b,x=o*d-r*v,y=r*b-a*d,_=Math.hypot(g,x,y);p.nx=g/_,p.ny=x/_,p.nz=y/_}r.push([p.nx*h,p.ny*h,p.nz*h])}let l=i.div+1;for(let t=0;t<e.div;++t){let e=t*l;for(let t=0;t<i.div;++t)h>0?o.push([e+t,e+t+l,e+t+l+1,e+t+1]):o.push([e+t+1,e+t+l+1,e+t+l,e+t])}return this.obj_v=n,this.obj_n=r,a.length>0&&(this.obj_t=a),this.obj_i=o,this}objModel(t,e){let i=this.obj_v,s=this.obj_i,n=this.obj_n,r=this.obj_t,a=this.obj_c,o=[],h=[],u=[],c=[],l=0;n||(this.obj_n=[]);for(let t=0,e=s.length;t<e;t++){let e=s[t];if(!n){let s=[];for(let t=0;t<3;t++)s[t]=i[e[t]];let n=s[1][0]-s[0][0],r=s[1][1]-s[0][1],a=s[1][2]-s[0][2],o=s[2][0]-s[0][0],h=s[2][1]-s[0][1],l=s[2][2]-s[0][2],f=r*l-a*h,p=-n*l+a*o,m=n*h-r*o,d=Math.hypot(f,p,m);f/=d,p/=d,m/=d,u.push([f,p,m]);for(let i=0,s=e.length;i<s;i++)c[e[i]]||(c[e[i]]=[]),c[e[i]].push(t)}for(let t=1,i=e.length-1;t<i;t++)h.push(e[0]),h.push(e[t]),h.push(e[t+1]);l+=e.length}console.log(" vert:"+i.length),console.log(" poly:"+h.length/3);for(let e=0,s=i.length;e<s;e++){o.push(parseFloat(i[e][0])),o.push(parseFloat(i[e][1])),o.push(parseFloat(i[e][2]));let s=0,h=0,l=0;if(n)s=n[e][0],h=n[e][1],l=n[e][2];else for(let t=0;t<c[e].length;t++){let i=c[e][t];s+=u[i][0],h+=u[i][1],l+=u[i][2]}let f=Math.hypot(s,h,l);if(0==f?(o.push(0),o.push(0),o.push(0)):(o.push(s/f),o.push(h/f),o.push(l/f)),n||this.obj_n.push([s/f,h/f,l/f]),r&&(o.push(parseFloat(r[e][0])),o.push(parseFloat(r[e][1]))),a&&(o.push(parseFloat(a[e][0])),o.push(parseFloat(a[e][1])),o.push(parseFloat(a[e][2]))),t)for(av=0;av<t.length;av++)o=o.concat(t[av].data[e])}this.ibuf=h,this.vbuf=o;let f={mode:"tri",vtx_at:["position","norm"],vtx:o,idx:h};if(r&&f.vtx_at.push("uv"),a&&f.vtx_at.push("color"),t)for(av=0;av<t.length;av++)f.vtx_at.push(t[av].attr);return f}normLines(t){let e=[],i=this.obj_v,s=this.obj_n;void 0==t&&(t=.1);for(let n=0,r=i.length;n<r;n++)e.push(i[n][0]),e.push(i[n][1]),e.push(i[n][2]),e.push(i[n][0]+s[n][0]*t),e.push(i[n][1]+s[n][1]*t),e.push(i[n][2]+s[n][2]*t);return{mode:"lines",vtx_at:["position"],vtx:e}}wireframe(){let t=[],e=this.obj_v,i=this.obj_i;for(let s=0,n=i.length;s<n;s++){let n,r=i[s];for(n=1;n<r.length;n++)t.push(e[r[n-1]][0]),t.push(e[r[n-1]][1]),t.push(e[r[n-1]][2]),t.push(e[r[n]][0]),t.push(e[r[n]][1]),t.push(e[r[n]][2]);t.push(e[r[n-1]][0]),t.push(e[r[n-1]][1]),t.push(e[r[n-1]][2]),t.push(e[r[0]][0]),t.push(e[r[0]][1]),t.push(e[r[0]][2])}return{mode:"lines",vtx_at:["position"],vtx:t}}multMatrix4(t){let i=new e(t).invert().transpose(),s=t.getAsArray();for(let t=0;t<this.obj_v.length;t++){let e=this.obj_v[t],i=s[0]*e[0]+s[4]*e[1]+s[8]*e[2]+s[12],n=s[1]*e[0]+s[5]*e[1]+s[9]*e[2]+s[13],r=s[2]*e[0]+s[6]*e[1]+s[10]*e[2]+s[14];this.obj_v[t]=[i,n,r]}s=i.getAsArray();for(let t=0;t<this.obj_n.length;t++){let e=this.obj_n[t],i=s[0]*e[0]+s[4]*e[1]+s[8]*e[2]+s[12],n=s[1]*e[0]+s[5]*e[1]+s[9]*e[2]+s[13],r=s[2]*e[0]+s[6]*e[1]+s[10]*e[2]+s[14];this.obj_n[t]=[i,n,r]}}mergeModels(t){let e=this,i=0;for(let s=0;s<t.length;s++){e.obj_v=e.obj_v.concat(t[s].obj_v),e.obj_n=e.obj_n.concat(t[s].obj_n),e.obj_t=e.obj_t.concat(t[s].obj_t);for(let r=0;r<t[s].obj_i.length;r++){let a=t[s].obj_i[r],o=[];for(n=0;n<a.length;n++)o.push(a[n]+i);e.obj_i.push(o)}i+=t[s].obj_v.length}return e}boundbox(){let t=Number.MAX_VALUE,e=t,i=t,s=Number.MIN_VALUE,n=s,r=s;for(let a=0;a<this.obj_v.length;a++){let o=this.obj_v[a];o[0]<t&&(t=o[0]),o[1]<e&&(e=o[1]),o[2]<i&&(i=o[2]),o[0]>s&&(s=o[0]),o[1]>n&&(n=o[1]),o[2]>r&&(r=o[2])}return[[t,e,i],[s,n,r]]}loadAjax(t){return new Promise(function(e,i){let s=new XMLHttpRequest;s.open("get",t,!0),s.responseType="text",s.onload=function(){200==this.status?e(this.response):i("Ajax error:"+this.statusText)},s.onerror=function(){i("Ajax error:"+this.statusText)},s.send()})}static loadLines(t,e,i){i||(i=1e4);const s=new TextDecoder;return new Promise((n,r)=>{fetch(t,{method:"GET"}).then(async t=>{if(t.ok){const r=t.body.getReader(),a=new Uint8Array(i);let o=0;for(;;){const{done:i,value:h}=await r.read();if(i){e(s.decode(a.slice(0,o))),n(t);break}for(const t of h)a[o++]=t,10==t&&(e(s.decode(a.slice(0,o-1))),o=0)}}else r(t)})})}async loadObj(t,e){return e||(e=1),new Promise((i,s)=>{this.loadAjax(t).then(s=>{let n=s.split("\n"),r=[],a=[],o=[],h=[],u=[],c={},l=0;for(let t=0,i=n.length;t<i;t++){if(n[t].match(/^#/))continue;if(n[t].match(/^eof/))break;let i=n[t].split(/\s+/);if("v"==i[0]&&(r.push([i[1]*e,i[2]*e,i[3]*e]),7==i.length&&u.push([i[4],i[5],i[6]])),"vt"==i[0]&&h.push([i[1],i[2]]),"vn"==i[0]&&a.push([i[1],i[2],i[3]]),"f"==i[0]){let t=[];for(let e=1;e<i.length;e++)""!=i[e]&&(i[e]in c||(c[i[e]]=l++),t.push(c[i[e]]));o.push(t)}}if(this.obj_v=[],u.length>0&&(this.obj_c=[]),this.obj_i=o,a.length>0&&(this.obj_n=[]),h.length>0&&(this.obj_t=[]),o.length>0)for(let t in c){let e=t.split("/"),i=c[t];this.obj_v[i]=r[e[0]-1],u.length>0&&(this.obj_c[i]=u[e[0]-1]),h.length>0&&(this.obj_t[i]=h[e[1]-1]),a.length>0&&(this.obj_n[i]=a[e[2]-1])}else this.obj_v=r,u.length>0&&(this.obj_c=u),a.length>0&&(this.obj_n=a);console.log("loadobj "+t+" vtx:"+r.length+" norm:"+a.length+" tex:"+h.length+" idx:"+o.length+" vbuf:"+this.obj_v.length),i(this)}).catch(function(t){s(t)})})}static async loadObj2(t,e){let s=1,n=!1,r=!1,a=!1;return e&&(e.scale&&(s=e.scale),e.zup&&(n=e.zup),e.nogroup&&(r=e.nogroup),e.nomtl&&(a=e.nomtl)),new Promise((e,o)=>{const h=[],u=[],c={},l=[],f=[],p={},m=[];let d=0,b="",v="";const g=[],x=[];i.loadLines(t,async e=>{if(e.match(/^#/))return;if(e.match(/^eof/))return;const o=e.split(/\s+/),y=o[0];if("v"==y&&(n?h.push([o[1]*s,o[3]*s,-o[2]*s]):h.push([o[1]*s,o[2]*s,o[3]*s]),7==o.length&&f.push([o[4],o[5],o[6]])),"vt"==y&&l.push([o[1],o[2]]),"vn"==y&&(n?u.push([o[1],o[3],-o[2]]):u.push([o[1],o[2],o[3]])),"f"==y){let t=[];for(let e=1;e<o.length;e++)""!=o[e]&&(o[e]in p||(p[o[e]]=d++,m[p[o[e]]]=o[e]),t.push(p[o[e]]));c[v]||(c[v]={}),c[v][b]||(c[v][b]=[]),c[v][b].push(t)}if("mtllib"==y){let e=t.split("/");e[e.length-1]=o[1],g.push(i.loadMtl(e.join("/"))),x.push(e)}"usemtl"==y&&(a||(b=o[1])),"g"==y&&(r||(v=o[1]))}).then(s=>{const n=[];let a;console.log(c),console.log(m);for(let e in c){a=[];for(let s in c[e]){let n=c[e][s];const r=new i;if(r.obj_v=[],f.length>0&&(r.obj_c=[]),u.length>0&&(r.obj_n=[]),l.length>0&&(r.obj_t=[]),r.obj_i=n,n.length>0)for(let t in p){let e=t.split("/"),i=p[t];r.obj_v[i]=h[e[0]-1],f.length>0&&(r.obj_c[i]=f[e[0]-1]),l.length>0&&(r.obj_t[i]=l[e[1]-1]),u.length>0&&(r.obj_n[i]=u[e[2]-1])}else r.obj_v=h,f.length>0&&(r.obj_c=f),u.length>0&&(r.obj_n=u);a.push({obj:r,mtlname:s}),console.log("loadobj "+t+" vtx:"+h.length+" norm:"+u.length+" tex:"+l.length+" idx:"+n.length+" vbuf:"+r.obj_v.length)}n.push({objs:a,group:e})}g.length>0?Promise.all(g).then(t=>{let i={};for(let e in t)i=Object.assign(i,t[e]);e(r?{objs:a,mtls:i}:{groups:n,mtls:i})}):e(r?{objs:a}:{groups:n})}).catch(t=>{o(t)})})}static async loadMtl(t){const e=[];let s="";return new Promise((n,r)=>{i.loadLines(t,t=>{if(t.match(/^#/))return;if(t.match(/^eof/))return;const i=t.split(/\s+/),n=i[0];if("newmtl"==n)return s=i[1],void(e[s]={});switch(n){case"Kd":case"Ks":case"Ka":case"Tf":e[s][n]=[parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3])];break;case"Ni":case"d":case"Ns":e[s][n]=parseFloat(i[1]);break;case"illum":e[s][n]=parseInt(i[1]);break;case"map_Kd":case"map_Ka":case"map_Ks":e[s][n]=i[1]}}).then(t=>{n(e)}).catch(t=>{r(t)})})}static HSV2RGB(t,e,i,s){let n,r,a,o,h,u,c;switch(t*=6,n=Math.floor(t),r=t-n,1&n||(r=1-r),a=i*(1-e),o=i*(1-e*r),n){case 0:case 6:h=i,u=o,c=a;break;case 1:h=o,u=i,c=a;break;case 2:h=a,u=i,c=o;break;case 3:h=a,u=o,c=i;break;case 4:h=o,u=a,c=i;break;case 5:h=i,u=a,c=o}return[h,u,c,void 0===s?1:s]}static snormal(t){let e=t[1][0]-t[0][0],i=t[1][1]-t[0][1],s=t[1][2]-t[0][2],n=t[2][0]-t[0][0],r=t[2][1]-t[0][1],a=t[2][2]-t[0][2],o=i*a-s*r,h=-e*a+s*n,u=e*r-i*n,c=Math.hypot(o,h,u);return[o/=c,h/=c,u/=c]}}return t.WWModel=i}),t("skylark-pox/Player",["./pox","./CanvasMatrix4","./GPad","./Pointer","./Camera","./Device","./WBind","./WWG","./WWModel"],function(t,e,i,s,n,r,a,o,h){"use strict";t.$;const u=e;t.RAD;class c{constructor(t,s){if(this.version="2.2.0",!Promise)throw"This browser is not supported!!";s||(s={}),this.can=t instanceof HTMLElement?t:document.querySelector(t);const n=new o,u={preserveDrawingBuffer:s.capture,antialias:!0,xrCompatible:!0},c=!s.noWebGL2;if(!(c&&n.init2(this.can,u)||n.init(this.can,u)))throw"wgl not supported!";if(s.needWebGL2&&2!=n.version)throw"needs wgl2";this.wwg=n;const l=a.create();this.param=l,l.bindInput("isStereo",s.ui&&s.ui.isStereo?s.ui.isStereo:"#isstereo"),l.bindInput("autorot",s.ui&&s.ui.autorot?s.ui.autorot:"#autorot"),l.bindInput("pause",s.ui&&s.ui.pause?s.ui.pause:"#pause"),l.bindHtml("fps",s.ui&&s.ui.fps?s.ui.fps:"#fps"),l.bindInput("camselect",s.ui&&s.ui.camselect?s.ui.camselect:"#camselect"),this.pixRatio=1,this.pox={can:this.can,wwg:this.wwg,WWModel:h,CanvasMatrix4:e,Mat4:e,synth:this.synth,poxp:this},this.eventListener={},i&&(this.pox.gPad=new i,this.pox.gPad.name="1",this.pox.gPad2=new i,this.pox.gPad2.name="2",this.pox.gPad.init(0,(t,e)=>{e&&this.pox.log("set 1"+t.gp.hand)})||this.pox.gPad2.init(1,(t,e)=>{e&&this.pox.log("set 2"+t.gp.hand)})||(this.pox.gPad.ev=(t=>{ret=this.callEvent("gpad",t)})),this.pox.gPad2.ev=((t,e,i)=>{ret=this.callEvent("gpad",t)})),this.resize(),window.addEventListener("resize",()=>{this.resize()}),this.pause=!0;const f=document.createElement("input");f.setAttribute("type","checkbox"),f.style.position="absolute",f.style.zIndex=-100,f.style.top=0,f.style.left="-20px",f.style.width="10px",f.style.height="10px",f.style.padding=0,f.style.border="none",f.style.opacity=0,this.can.parentNode.appendChild(f),this.keyElelment=f,this.keyElelment.focus(),this.setEvent(),r.checkVR(this).then(t=>{t&&console.log(r.vrDisplay?"WebVR":"WebXR supported"),this.vrReady=t}),this.cam0=this.createCamera(),this.cam0.setCam({camFar:1e4}),this.cam1=this.createCamera(),this.ccam=this.cam1}addEvent(t,e){let i=null;switch(t){case"frame":i={cb:e,active:!0},this.eventListener.frame.push(i);break;case"gpad":i={cb:e,active:!0},this.eventListener.gpad.push(i);break;case"vrchange":i={cb:e,active:!0},this.eventListener.vrchange.push(i)}return i}removeEvent(t){this.eventListener.frame=this.eventListener.frame.filter(e=>e!==t),this.eventListener.gpad=this.eventListener.gpad.filter(e=>e!==t),this.eventListener.vrchange=this.eventListener.vrchange.filter(e=>e!==t)}clearEvent(){this.eventListener.frame=[],this.eventListener.gpad=[],this.eventListener.vrchange=[]}enterVR(){let t=!0;if(r.VRReady)console.log("enter VR"),r.presentVR(this);else if(document.body.webkitRequestFullscreen){console.log("fullscreen");const t=this.can.parentNode;this.ssize={width:t.offsetWidth,height:t.offsetHeight},document.addEventListener("webkitfullscreenchange",e=>{document.webkitFullscreenElement?(t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px"):(t.style.width=this.ssize.width+"px",t.style.height=this.ssize.height+"px")}),t.webkitRequestFullscreen()}else t=!1;return t}exitVR(){r.VRReady&&r.closeVR(this)}setEvent(){let t=!1;const e=this.param,i=this.can;new s(i,{down:i=>{if(!this.ccam||e.pause)return!0;let s=!0;return(s=this.callEvent("down",{x:i.x*this.pixRatio,y:i.y*this.pixRatio,sx:i.sx*this.pixRatio,sy:i.sy*this.pixRatio}))&&this.ccam.event("down",i),t=!0,"walk"==this.ccam.cam.camMode&&this.keyElelment.focus(),!1},move:t=>{if(!this.ccam||e.pause)return!0;let i=!0;return(i=this.callEvent("move",{x:t.x*this.pixRatio,y:t.y*this.pixRatio,ox:t.ox*this.pixRatio,oy:t.oy*this.pixRatio,dx:t.dx*this.pixRatio,dy:t.dy*this.pixRatio}))&&this.ccam.event("move",t),!1},up:e=>{if(!this.ccam)return!0;t=!1;let i=!0;return(i=this.callEvent("up",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio,ex:e.ex*this.pixRatio,ey:e.ey*this.pixRatio}))&&this.ccam.event("up",e),!1},out:e=>{if(!this.ccam)return!0;t=!1;let i=!0;return(i=this.callEvent("out",{x:e.x*this.pixRatio,y:e.y*this.pixRatio,dx:e.dx*this.pixRatio,dy:e.dy*this.pixRatio}))&&this.ccam.event("out",e),!1},wheel:t=>{if(!this.ccam||e.pause)return!0;let i=!0;return(i=this.callEvent("wheel",t))&&this.ccam.event("wheel",t),!1},gesture:(t,i)=>{if(!this.ccam||e.pause)return!0;let s=!0;return(s=this.callEvent("gesture",{z:t,r:i}))&&this.ccam.event("gesture",{z:t,r:i}),!1},gyro:i=>{if(!this.ccam||e.pause||r.VRReady)return!0;if(t)return!0;let s=!0;return(s=this.callEvent("gyro",i))&&this.ccam.event("gyro",i),!1}});a.addev(this.keyElelment,"keydown",t=>!!e.pause||(!(!this.pox.event||this.callEvent("keydown",t))||(this.ccam&&this.ccam.event("keydown",t),!1))),a.addev(this.keyElelment,"keyup",t=>!!e.pause||(!(!this.pox.event||this.callEvent("keyup",t))||(this.ccam&&this.ccam.event("keyup",t),!1))),document.querySelectorAll("#bc button").forEach(t=>{t.addEventListener("mousedown",t=>{this.callEvent("btndown",t.target.id),this.ccam.event("keydown",{key:t.target.getAttribute("data-key")}),t.preventDefault()}),t.addEventListener("touchstart",t=>{this.callEvent("touchstart",t.target.id),this.ccam.event("keydown",{key:t.target.getAttribute("data-key")}),t.preventDefault()}),t.addEventListener("mouseup",t=>{this.callEvent("btnup",t.target.id),this.ccam.event("keyup",{key:t.target.getAttribute("data-key")}),this.keyElelment.focus(),t.preventDefault()}),t.addEventListener("touchend",t=>{ret=!0,ret=this.callEvent("touchend",t.target.id),ret&&this.ccam.event("keyup",{key:t.target.getAttribute("data-key")}),t.preventDefault()})})}resize(){this.can.offsetWidth<300||r.isPresenting||(this.can.width=this.can.offsetWidth*this.pixRatio*window.devicePixelRatio,this.can.height=this.can.offsetHeight*this.pixRatio*window.devicePixelRatio,console.log("canvas:"+this.can.width+" x "+this.can.height))}async load(t){return new Promise((e,i)=>{if("string"==typeof t){const s=new XMLHttpRequest;s.open("get",t,!0),s.responseType="json",s.onload=(()=>{200==s.status?e(s.response):i("Ajax error:"+s.statusText)}),s.onerror=(()=>{i("Ajax error:"+s.statusText)}),s.send()}else e(t)})}loadImage(t){return t.match(/^https?:/)?this.wwg.loadImageAjax(t):new Promise((e,i)=>{const s=new Image;s.onload=(()=>{e(s)}),s.onerror=(()=>{i("cannot load image")}),s.src=t})}async set(t,e={},i){t.vs,t.fs;this.pox.src=t,this.pox.param=e;const s=this.pox;if(s.loadImage=this.loadImage,s.loadAjax=this.wwg.loadAjax,s.addEvent=((t,e)=>this.addEvent(t,e)),s.exitVR=this.exitVR,s.V3add=function(){let t=0,e=0,i=0;for(let s=0;s<arguments.length;s++)t+=arguments[s][0],e+=arguments[s][1],i+=arguments[s][2];return[t,e,i]},s.V3len=function(t){return Math.hypot(t[0],t[1],t[2])},s.V3norm=function(t,e){const i=V3len(t);return void 0===e&&(e=1),0==i?[0,0,0]:[t[0]*e/i,t[1]*e/i,t[2]*e/i]},s.V3mult=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},s.V3dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},s.Vdistance=function(t,e){return Math.hypot(...t.map((t,i)=>t-e[i]))},s.setScene=(async t=>new Promise((e,i)=>{this.setScene(t).then(()=>{e()}).catch(t=>{console.log("render err"+t.stack)})})),s.log=(t=>{this.errCb&&this.errCb(t)}),s.addModel=(t=>{if(this.render)return this.render.addModel(t)}),s.removeModel=(t=>{if(this.render)return this.render.removeModel(t)}),s.getModelData=(t=>{if(this.render)return this.render.getModelData(t)}),"string"==typeof t.m){const e=await this.parseJS(t.m);try{s.eval=new Function("POX",'"use strict";'+e)}catch(t){return console.log(t),this.emsg="parse error "+t.stack,null}try{s.eval(s)}catch(t){return this.emsg="eval error "+t.stack,null}}else if(t.m.constructor===Function)try{t.m(s)}catch(t){return this.emsg="eval error "+t.stack,null}if(s.setting.needWGL2&&2!=this.wwg.version)return this.emsg="needs WebGL 2.0",null;if(i&&this.setParam(i),s.init)try{await s.init()}catch(t){return this.emsg="init error "+t.stack,null}return s}parseJS(t){return new Promise((e,i)=>{const s=t.split("\n"),n=[];for(let t of s)t.match(/^\/\/\@INCLUDE\("(.+)"\)/)&&n.push(this.wwg.loadAjax(RegExp.$1));Promise.all(n).then(t=>{let i=[],n=0;for(let e of s)e.match(/^\/\/\@INCLUDE\("(.+)"\)/)?i=i.concat(t[n++].split("\n")):i.push(e);e(i.join("\n"))})})}stop(){window.cancelAnimationFrame(this.loop),this.pox.unload&&this.pox.unload()}cls(){this.render&&this.render.clear()}setError(t){this.errCb=t}callEvent(t,e,i){"object"==typeof e&&(e.rtime=this.rtime);let s=!0;if(this.pox.event)try{s=this.pox.event(t,e,i)}catch(t){this.errCb(t.stack)}if("vrchange"==t){this.ccam.vrchange(e);for(let t=0;t<this.eventListener.vrchange.length;t++){const i=this.eventListener.vrchange[t];i.active&&i.cb({vrmode:e})}}if("gpad"==t){-1==e.dbtn[5]&&r.closeVR();for(let t=0;t<this.eventListener.gpad.length;t++){const i=this.eventListener.gpad[t];if(i.active){let t={gpad:e};"left"==e.hand&&(t.leftPad=e),"right"==e.hand&&(t.rightPad=e),this.pox.setting.primaryPad==e.hand?t.primaryPad=e:t.secondaryPad=e,i.cb(t)}}}return s}setParam(t){const e=this.pox.setting.param;if(void 0===e)return;this.uparam=a.create();const i=[];for(let t in e){const s=e[t],n=s.name?s.name:t;s.type||(s.type="range"),s.step||(s.step=100);let r=`<div class=t>${n}</div> <input type=${s.type} id="_p_${t}" min=0 max=${s.step} style="${"disp"==s.type?"display:none":""}"  /><span id=${"_p_d_"+t}></span><br/>`;i.push(r)}function s(t){let e=(255*t).toString(16);return 1==e.length&&(e="0"+e),e}function n(t,i){"color"==e[t].type&&i?document.getElementById("_p_d_"+t).innerHTML=i.map(t=>t.toString().substr(0,5)):"range"==e[t].type?document.getElementById("_p_d_"+t).innerHTML=i.toString().substr(0,5):document.getElementById("_p_d_"+t).innerHTML=i}t.innerHTML=i.join("");for(let t in e)this.uparam.bindInput(t,"#_p_"+t),this.uparam.setFunc(t,{set:i=>{let r=i;return r="color"==e[t].type?"#"+s(i[0])+s(i[1])+s(i[2]):"range"==e[t].type?(i-e[t].min)*e[t].step/(e[t].max-e[t].min):i,n(t,i),r},get:i=>{let s;return s="color"==e[t].type?"string"==typeof i&&i.match(/#[0-9A-F]+/i)?[parseInt(i.substr(1,2),16)/255,parseInt(i.substr(3,2),16)/255,parseInt(i.substr(5,2),16)/255]:i:"range"==e[t].type?i*(e[t].max-e[t].min)/e[t].step+e[t].min:i},input:e=>{n(t,this.uparam[t])}}),this.uparam[t]=e[t].value;this.pox.param=this.uparam}setScene(t){const i=this.wwg,s=this.pox,n=this.can,a=(this.pixRatio,this.param),o=s.setting||{};o.scale||(o.scale=1),o.primaryPad||(o.primaryPad="right"),t.vshader={text:s.src.vs},t.fshader={text:s.src.fs},s.scene=t;const h=i.createRender();this.render=h,s.render=h;let c=this.ccam;this.isVR=!1;const l=this,f=new e,p=[],m=[],d=[],b=[],v=[];return new Promise((e,i)=>{h.setRender(t).then(()=>{this.errCb&&this.errCb("scene set ok"),this.renderStart&&this.renderStart(),s.setting&&s.setting.pixRatio?this.pixRatio=s.setting.pixRatio:this.pixRatio=1,this.resize(),s.setting.cam&&this.cam1.setCam(s.setting.cam),this.keyElelment.value="",this.clearEvent(),e();let t=(new Date).getTime();this.ctime=t,this.ltime=t;let i=0,u=0,f=t,p=0;const m=(e,d)=>{r.animationFrame(this,m,d);const b=(new Date).getTime();if(this.ctime=b,a.pause)return a.fps=0,i=u,void(t=b);u=i+b-t,p++,b-f>=500&&(a.fps=Math.floor(1e3*p/(b-f)+.5),p=0,f=b),this.ccam=a.camselect?this.cam0:this.cam1,c=this.ccam,s.cam=c.cam,a.autorot&&c.setCam({camRY:u/100%360});let v=null,g=null,y=null,_=null;if(s.gPad){let t=s.gPad.get(),e=s.gPad2.get();this.isVR?(t.emu||"right"!=t.hand||(v=t),t.emu||"left"!=t.hand||(g=t),e.emu||"right"!=e.hand||(v=e),e.emu||"left"!=e.hand||(g=e)):("right"==t.hand&&(v=t),"right"==e.hand&&(v=e),"left"==t.hand&&(g=t),"left"==e.hand&&(g=e)),"left"==o.primaryPad?(y=g,_=v):(y=v,_=g),y&&y.conn||(y=_,_=null),c.cam.gPad&&c.setPad(y,_)}c.update();let w=c.getMtx(o.scale,a.isStereo||l.isVR?1:0);for(let t=0;t<this.eventListener.frame.length;t++){const e=this.eventListener.frame[t];e.active&&e.cb({render:h,pox:s,ccam:c,cam:c.cam,rtime:u,rightPad:v,leftPad:g,primaryPad:y,secondaryPad:_})}let R={};s.update&&(R=s.update(h,c.cam,u,-1)),a.updateTimer(),function(t,e,i,s,o){if(t.data.model.sort((t,e)=>{if(null===t)return-1;if(null===e)return 1;let i=t.layer,s=e.layer;return void 0===i&&(i=0),void 0===s&&(s=0),i-s}),a.isStereo||l.isVR){let e=r.getViewport(n);r.WebXR&&r.isPresenting&&t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,r.webGLLayer.framebuffer);let a=x(t,i);void 0===o.vs_uni&&(o.vs_uni={}),void 0===o.fs_uni&&(o.fs_uni={}),o.fs_uni.time=s/1e3,o.vs_uni.time=s/1e3,t.gl.viewport(e.leftViewport.x,e.leftViewport.y,e.leftViewport.width,e.leftViewport.height),t.draw([o,a[0]],!1),t.gl.viewport(e.rightViewport.x,e.rightViewport.y,e.rightViewport.width,e.rightViewport.height),t.draw([o,a[1]],!0),r.WebXR&&r.isPresenting&&t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null)}else{let e=x(t,i);void 0===o.vs_uni&&(o.vs_uni={}),void 0===o.fs_uni&&(o.fs_uni={}),e[0].vs_uni.stereo=0,o.fs_uni.time=s/1e3,o.vs_uni.time=s/1e3,t.gl.viewport(0,0,n.width,n.height),t.draw([o,e[0]],!1)}}(h,0,w,u,R),r.submitFrame(this),this.ltime=b,this.rtime=u};m()}).catch(t=>{console.log(t),this.errCb&&this.errCb(t.stack?t.stack:t),i(t)})});function g(t,e){let i=t.getModelData(e);if(!i)return new u;let s=new u(i.bm);return s||(s=new u),i.mm&&s.multRight(i.mm),void 0!==i.parent&&s.multRight(g(t,i.parent)),s}function x(t,i){const s=[[],[]],r=t.data.model;for(let n=0;n<r.length;n++){let a=r[n];if(!a)continue;if(f.load(a.bm),a.mm&&f.multRight(a.mm),void 0!==a.parent&&f.multRight(g(t,a.parent)),t.data.group){let e=t.data.group;for(let i=0;i<e.length;i++){let s=e[i];if(s.bm)for(let e=0;e<s.model.length;e++)t.getModelIdx(s.model[e])==n&&f.multRight(s.bm)}}p[n]||(p[n]=new e),b[n]||(b[n]=new e),v[n]||(v[n]=new e),m[n]||(m[n]=[new e,new e]),d[n]||(d[n]=[new e,new e]);const o={vs_uni:{modelMatrix:p[n].load(f).getAsWebGLFloatArray(),vpMatrix:d[n][0].load(a.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),mvpMatrix:m[n][0].load(f).multRight(a.camFix?i[0].camP:i[0].camVP).getAsWebGLFloatArray(),invMatrix:b[n].load(f).invert().transpose().getAsWebGLFloatArray(),minvMatrix:v[n].load(f).invert().getAsWebGLFloatArray()}},h={vs_uni:{modelMatrix:p[n].load(f).getAsWebGLFloatArray(),vpMatrix:d[n][1].load(a.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),mvpMatrix:m[n][1].load(f).multRight(a.camFix?i[1].camP:i[1].camVP).getAsWebGLFloatArray(),invMatrix:b[n].load(f).invert().transpose().getAsWebGLFloatArray(),minvMatrix:v[n].load(f).invert().getAsWebGLFloatArray()}};o.fs_uni=o.vs_uni,h.fs_uni=h.vs_uni,o.fs_uni.vpMatrix_l=o.fs_uni.vpMatrix,o.fs_uni.vpMatrix_r=h.fs_uni.vpMatrix,h.fs_uni.vpMatrix_l=o.fs_uni.vpMatrix,h.fs_uni.vpMatrix_r=h.fs_uni.vpMatrix,s[0][n]=o,s[1][n]=h}let a=[{model:s[0],fs_uni:{},vs_uni:{}},{model:s[1],fs_uni:{},vs_uni:{}}];return a[0].fs_uni.stereo=1,a[0].fs_uni.resolution=[n.width,n.height],a[0].fs_uni.camMatirx=i[0].camV.getAsWebGLFloatArray(),a[0].fs_uni.eyevec=[i[0].camX,i[0].camY,i[0].camZ],a[0].vs_uni.stereo=1,a[0].vs_uni.camMatirx=a[0].fs_uni.camMatirx,a[0].vs_uni.eyevec=a[0].fs_uni.eyevec,a[1].fs_uni.stereo=2,a[1].fs_uni.resolution=a[0].fs_uni.resolution,a[1].fs_uni.camMatirx=i[1].camV.getAsWebGLFloatArray(),a[1].fs_uni.eyevec=[i[1].camX,i[1].camY,i[1].camZ],a[1].vs_uni.stereo=2,a[1].vs_uni.camMatirx=a[1].fs_uni.camMatirx,a[1].vs_uni.eyevec=a[1].fs_uni.eyevec,a}}}return c.prototype.createCamera=function(t){return new this.Camera(this,t)},c.prototype.Camera=n,t.Player=c}),t("skylark-pox/main",["./pox","./Player"],function(t,e){return t}),t("skylark-pox",["skylark-pox/main"],function(t){return t}),t("skylark-vr360viewer/v360",["skylark-langx/skylark","skylark-pox"],function(t,e){e.WWModel;const i={m:'let src,mode \nlet angh = 63 \nif(POX.param.param) {\n\tsrc = POX.param.param[0] ;\n\tmode = 0 \n\tif(POX.param.param[1]) mode = POX.param.param[1] ;\n\tif(mode==3 && POX.param.param[2]) angh = POX.param.param[2] ;\n}\n\n//settings\nPOX.setting={\n\tname:"theta_view_vr4",\n\tscale:1.0,\n\tgyro:true,\n\thighRefreshRate:true,\n\tfoveationLevel:0,\n\tcam:{\n\tcamMode:"vr",\n\tgPad:true,\n\tcamAngle:90,\n\tcamCX:0,\n\tcamCY:1.5,\n\tcamCZ:0,\n\tcamRX:0,\n\tcamRZ:0,\n\tcamRY:-90,\n\tcamFar:2000,\n\tcamNear:0.01}\n};\n// light params\nconst lvec = [\n\t\t[0,5,1],\n\t\t[0,-1,0]\n\t]\nconst lcol = [\n\t\t[1,1,1],\n\t\t[0.5,0.5,1]\n\t]\nconst lparam = [\n\t\t[1,0],\n\t\t[0.5,0]\n\t]\n//scenedatass\nPOX.loadImage(src).then(function(img) {\n\tconst can1 = document.createElement(\'canvas\') ;\n\tconst can2 = document.createElement(\'canvas\') ;\n\tlet cw = (POX.wwg.version==1)?4096:img.width/2 \n\tlet ch = (POX.wwg.version==1)?4096:img.height\n\tlet sw = img.width/2 \n\tif(mode==5) {\n\t\tcw = (POX.wwg.version==1)?4096:img.width\n\t\tsw = img.width \n\t}\n\tif(cw>4096) {\n\t\tch = ch * cw/4096 ;cw = 4096 ;\n\t}\n\tPOX.log(cw+"*"+ch)\n\tcan1.width = cw ;\n\tcan1.height = ch ;\n\tlet  ctx = can1.getContext("2d") ;\n\tctx.drawImage(img,0,0,sw,img.height,0,0,cw,ch) ;\n\tcan2.width = cw \n\tcan2.height = ch \n\tctx = can2.getContext("2d") \n\tctx.drawImage(img,sw,0,sw,img.height,0,0,cw,ch) ;\n\t\n\tconst sky = new POX.WWModel();\n\tsky.primitive("sphere",{div:40,wx:20,wy:20,\n\twz:20,ninv:true});\n\t\n\tconst scene={\n\t\tenv:{clear_color:[0.0,0.0,0.0,1.0],cull:true},\n\t\tvs_uni:{\n\t\t    col:[0.5,0.5,1.0,1.0]\n\t\t},\n\t\tfs_uni:{\n\t\t\tpamb:0.2,\n\t\t\tpdiff:0.8,\n\t\t\tpspec:0.,\n\t\t\tpref:0.0,\n\t\t\tdspec:60,\n\t\t\tambcolor:[0.,0.,0],\n\t\t\tlvec:lvec,\n\t\t\tlcol:lcol,\n\t\t\tlparam:lparam,\n\t\t\tcolmode:0,\n\t\t\tshmode:0,\n\t\t\tbcolor:[0,0,0,1],\n\t\t\tmode:mode,\n\t\t\tasp:img.width/img.height,\n\t\t\tangh:angh\n\t\t},\n\t\ttexture:[\n\t\t\t{canvas:can1,opt:{flevel:2,repeat:2}},\n\t\t\t{canvas:can2,opt:{flevel:2,repeat:2}}\n\t\t],\n\t\tmodel:[\n\t\t\t{geo:sky.objModel(),\n\t\t\tbm:new POX.CanvasMatrix4().translate(0,2,0),\n\t\t\tfs_uni:{colmode:10,shmode:1,tex1:0,tex2:1,mode:mode}\n\t\t\t},\n\t\t\t{geo:new POX.WWModel().primitive("plane",\n\t\t\t{wx:40,wz:40}).objModel(),hide:mode!=5,\n\t\t\tbm:new POX.Mat4().translate(0,0,0),\n\t\t\tfs_uni:{colmode:3,bcolor:[0.2,0.2,0.2,1]}\n\t\t\t},\n\t\t]\n\t}\n\tPOX.setScene(scene) ;\n})\nPOX.event = function(ev,d) {\n\tif(ev=="vrchange") {\n\t\tPOX.log("vr "+d)\n\t\tif(d==1) {\n\t\t\tPOX.cam.camRX = 0 \n\t\t}\n\t}\n\tif(ev=="gpad") {\n//\t\tconsole.log(d.dpad)\n\t\tif(d.dpad[0]>0 && d.axes[0]!=0) {\n\t\t\tPOX.cam.camRY += 30*(d.axes[0]>0?1:-1)\n\t\t}\n\t\tif(d.dbtn[4]>0) POX.poxp.exitVR()\n\t}\n\treturn true \n}\n\n//sceneupdate\nPOX.update=function(render,cam,time){\n\tconst ret={};\n\n\treturn ret;\n}\t\n',vs:"attribute vec3 position;\nattribute vec3 norm;\nattribute vec2 uv ;\n\nuniform mat4 modelMatrix;\nuniform mat4 mvpMatrix;\nuniform mat4 invMatrix;\nuniform vec4 col ;\n\nvarying vec3 tpos ;\nvarying vec3 tnorm ;\nvarying vec4 tcolor ;\nvarying vec2 tuv;\n\nvoid main() {\n\tvec2 uv2 = uv ;\n\ttcolor = col ;\n\ttuv\t= vec2(uv.x,1.0-uv.y);\n\ttpos = (modelMatrix * vec4(position,1.0)).xyz ;\n\ttnorm = (invMatrix * vec4(norm,0.0)).xyz ;\n\tgl_Position = mvpMatrix * vec4(position, 1.0) ;\n}\n",fs:"precision highp float;\nconst int lnum = 2 ;\n\nuniform int colmode ;\t//0:basecolor 1:vertex color  2:texture 3:checker 4:sky\nuniform int shmode ;\t//0:normal shading 1:no shading\nuniform vec4 bcolor ;\nuniform vec3 eyevec ;\nuniform float pamb ;\nuniform float pdiff ;\nuniform float pspec ;\nuniform float pref ;\nuniform float dspec ;\nuniform vec3 ambcolor ;\nuniform vec3 lvec[2];\nuniform vec3 lcol[2];\nuniform vec2 lparam[2] ;\nuniform float time ;\n\nuniform int mode ;\nuniform sampler2D tex1;\nuniform sampler2D tex2;\nuniform int stereo ;\nuniform float asp ;\nuniform float angh ;\n\nvarying vec3 tpos ;\nvarying vec3 tnorm ;\nvarying vec4 tcolor ;\nvarying vec2 tuv;\n\nconst float PI = radians(180.) ;\nconst vec3 spcol = vec3(1.,1.,1.) ;\nconst float dd = 0.5 ;\nconst float gamma = 1.0 ;\nconst float checkdiv = 0.02 ;\n\nvec3 skycol(vec2 uv) {\n\tvec3 col ;\n\tconst vec3 skycol = vec3(0.4,0.4,1.0);\n\tconst vec3 horizoncol = vec3(0.8,0.8,0.8) ;\n\tconst vec3 fieldcol = vec3(0.4,1.0,0.4) ;\n\tif(uv.y<0.5) col = mix(skycol,horizoncol,pow(uv.y*2.,5.)) ;\n\telse col = mix(horizoncol,fieldcol,pow(uv.y-0.5,1.)*2.);\n\treturn col ;\n}\n\nvec3 shade(vec3 col,vec3 norm) {\n\tvec3 ev = eyevec - tpos ;\n\tint i ;\n\tfloat diff,spec ;\n\tvec3 fcolor = vec3(0.);\n\tvec3 rcolor = vec3(0.) ;\n\t\n\tfor(int i=0;i<lnum;i++) {\n\t\tfloat lp = lparam[i].x ;\n\t\tif(lp==0.) continue ;\n\t\tvec3 lv = lvec[i] ;\n\t\tif(lparam[i].y!=0.) {\n\t\t\tlv = lv - tpos ;\n\t\t\tlp = (1.- pow(clamp(length(lv)/lparam[i].y,0.,1.),2.))*lparam[i].x ;\n\t\t}\n\t\tlv = normalize(lv) ;\n\t\tdiff= clamp((dot(norm,lv)+dd)/(1.+dd),0.0,1.0);\n\t\tif(pspec>0.)\n\t\t\tspec= pow(clamp(dot(norm,normalize(lv+normalize(ev))),0.0,1.0),dspec);\n\t\tfcolor = fcolor + (col * diff * pdiff + spcol* spec * pspec)*lcol[i].rgb*lp;\n\t}\n\tif(pref>0.) {\n\t\tvec3 ref = normalize(reflect(tpos - eyevec, tnorm));\n\t\tvec2 tc = vec2(\n\t\t\t\t(sign(ref.x)*acos(ref.z/sqrt(ref.x*ref.x+ref.z*ref.z))/PI+1.0)/2.0,\n\t\t\t\tacos(ref.y)/PI\n\t\t\t) ;\n\t\trcolor = skycol(tc) ;\n\t}\n\tfcolor = fcolor + col * ambcolor * pamb + rcolor * pref ;\n\tfcolor = pow(fcolor,vec3(1./gamma)) ;\n\treturn fcolor ;\n}\n\nvec3 gb(sampler2D map,vec2 px, float b) {\n\tvec3 p = texture2D(map, px).xyz ;\n\treturn p ;\n}\nvec3 vrmap(int mode) {\n\tconst float PI = radians(180.0) ;\n\tconst float PI2 = PI+PI ;\n\tvec2 tc = tuv ;\n\tvec3 col ;\n\tif(mode==3) {\n\t\tfloat ah = 180./angh ;\n\t\tfloat aw = 360./(angh*asp) ;\n\t\tfloat px = tc.x*aw*2.0 ;\n\t\tfloat py = tc.y*ah+(0.5-ah/2.);\n\t\tif(py<0. || py>1. || px-aw+1.<0. || px-aw>1.) col = bcolor.rgb ;\n\t\telse col = (tc.x<0.5)?texture2D(tex1, vec2(px-aw+1.,py)).xyz:\n\t\t\ttexture2D(tex2, vec2(px-aw,py)).xyz ;\t\t\n\t} else if(mode==2) {\n\t\tcol = (tc.x<0.25||tc.x>0.75)?bcolor.rgb:\n\t\t((stereo==1)?texture2D(tex1, vec2(tc.x*2.0-0.5,tc.y)).xyz:\n\t\t\ttexture2D(tex2, vec2(tc.x*2.0-0.5,tc.y)).xyz) ;\n\t} else if(mode==1) {\n\t\tcol = (tc.x<0.5)?texture2D(tex1, vec2(tc.x*2.0,tc.y/2.+((stereo==2)?0.5:0.))).xyz:\n\t\t\ttexture2D(tex2, vec2((tc.x-0.5)*2.0,tc.y/2.+((stereo==2)?0.5:0.))).xyz ;\n\t} else if(mode==5) {\n\t\tif(tc.y > 0.5) col = ambcolor ;\n\t\telse {\n\t\t\tfloat r = tc.x * PI2 + PI;\n\t\t\tfloat l = tc.y  ;\n\t\t\tcol = texture2D(tex1,\n\t\t\t\tvec2( l*sin(r)+0.5 ,l*cos(r)+0.5)).xyz ;\n\t\t}\n\t} else {\n\t\tcol = (tc.x<0.5)?texture2D(tex1, vec2(tc.x*2.0,tc.y)).xyz:\n\t\t\ttexture2D(tex2, vec2((tc.x-0.5)*2.0,tc.y)).xyz ;\n\t}\t\n\treturn col ;\n}\nvoid main() {\n\tvec4 color = (colmode==1)?tcolor:(colmode==2)?texture2D(tex1,tuv):bcolor ;\n\tvec3 col = color.rgb ;\n\tif(colmode==3) {\n\t\tcol = col * \n\t\t(((mod(tuv.x ,checkdiv) < checkdiv/2.) ^^ (mod(tuv.y ,checkdiv) < checkdiv/2.))?1.:0.8) ;\n\t}\n\tif(colmode==4) {\n\t\tfloat sun = clamp(dot(normalize(lvec[0]),-normalize(reflect(normalize(tpos), tnorm))),0.,1.) ;\n\t\tcol = skycol(tuv) + pow(sun,80.) * lcol[0]*0.6 ;\n\t}\n\tif(colmode==10) {\n\t\tcol = vrmap(mode) ;\n\t}\n\tvec3 norm = normalize(tnorm) ;\n\n\tgl_FragColor = vec4((shmode!=1)?shade(col,norm):col,color.a);\n}\n"};function s(t){return document.getElementById(t)}return t.attach("intg.v360",function(t,n){const r=document.createElement("div");r.innerHTML='<div class=cc>\n\t\t\t\t <span class=oswitch><label><input type=checkbox class=pause><span class=sbtn></span></label></span>\n\t\t\t\t <div class=pui></div></div>\n\t\t\t\t<div class=loading><img src="img/guruguru.gif"></div>\n\t\t\t\t<div class=vrbtn></div>\n\t\t\t\t<div class=footer><a href="https://github.com/wakufactory/vr360/" target="_blank">vr360</a></div>',t.appendChild(r);const a=document.createElement("canvas");t.appendChild(a);var o=new e.Player(a,{ui:{autorot:t.querySelector(".autorot"),pause:t.querySelector(".pause"),isStereo:t.querySelector(".isStereo"),fps:t.querySelector(".fps")}});t.player=o,(1==n.param[1]||2==n.param[1])&&(o.param.isStereo=!0);o.load(n.src||i).then(function(t){t,o.set(t,{param:n.param}).then(function(t){t.setting.copyright&&(s("footer").innerHTML+="&nbsp;&nbsp;"+t.setting.copyright),o.setParam(s("pui"))})}).catch(function(e){t.querySelector(".loading").style.display="none",alert(e)}),o.renderStart=function(){t.querySelector(".thumb").style.display="none",t.querySelector(".loading").style.display="none"},o.setError(function(t){console.log(t)}),t.querySelector(".vrbtn").addEventListener("click",t=>{const e=t.target.closest("div.poxe");document.querySelectorAll("div.poxe").forEach(t=>{t!=e&&t.player&&(t.player.param.pause=!0)}),e.player.param.pause=!1,o.enterVR()||(location.href="view.html?"+n.src)})})}),t("skylark-vr360viewer/main",["./v360"],function(t){return t}),t("skylark-vr360viewer",["skylark-vr360viewer/main"],function(t){return t})}(r),!a){var u=require("skylark-langx-ns");o?module.exports=u:e.skylarkjs=u}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-vr360viewer-all.js.map
